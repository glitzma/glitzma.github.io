<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>异常监控 | 马明娟</title>
    <meta name="generator" content="VuePress 1.9.9">
    
    <meta name="description" content="This is my blog">
    
    <link rel="preload" href="/assets/css/2.styles.e26ea78c.css" as="style"><link rel="preload" href="/assets/js/app~748942c6.e26ea78c.js" as="script"><link rel="preload" href="/assets/css/1.styles.de89d32b.css" as="style"><link rel="preload" href="/assets/js/app~2a42e354.de89d32b.js" as="script"><link rel="preload" href="/assets/css/styles.0d1d678c.css" as="style"><link rel="preload" href="/assets/js/app~1f20a385.0d1d678c.js" as="script"><link rel="preload" href="/assets/css/10.styles.685e93e4.css" as="style"><link rel="preload" href="/assets/js/10.685e93e4.js" as="script"><link rel="preload" href="/assets/js/29.58c20ca7.js" as="script"><link rel="prefetch" href="/assets/css/11.styles.db3fb87b.css"><link rel="prefetch" href="/assets/css/3.styles.2479901d.css"><link rel="prefetch" href="/assets/css/4.styles.14853dcd.css"><link rel="prefetch" href="/assets/css/5.styles.510e7b60.css"><link rel="prefetch" href="/assets/css/6.styles.3df49180.css"><link rel="prefetch" href="/assets/css/7.styles.4b781894.css"><link rel="prefetch" href="/assets/css/8.styles.40feba35.css"><link rel="prefetch" href="/assets/css/9.styles.2f72d411.css"><link rel="prefetch" href="/assets/js/11.db3fb87b.js"><link rel="prefetch" href="/assets/js/12.e1359aa3.js"><link rel="prefetch" href="/assets/js/13.f1d238b7.js"><link rel="prefetch" href="/assets/js/14.da55c5a9.js"><link rel="prefetch" href="/assets/js/15.6d6d4578.js"><link rel="prefetch" href="/assets/js/16.d3d55c31.js"><link rel="prefetch" href="/assets/js/17.d1124b5c.js"><link rel="prefetch" href="/assets/js/18.4fbc7487.js"><link rel="prefetch" href="/assets/js/19.cb848ea1.js"><link rel="prefetch" href="/assets/js/20.103a21d0.js"><link rel="prefetch" href="/assets/js/21.a1f3d9ef.js"><link rel="prefetch" href="/assets/js/22.e68afee7.js"><link rel="prefetch" href="/assets/js/23.8cf1b22b.js"><link rel="prefetch" href="/assets/js/24.663b8b19.js"><link rel="prefetch" href="/assets/js/25.342bc72e.js"><link rel="prefetch" href="/assets/js/26.7179c0a7.js"><link rel="prefetch" href="/assets/js/27.46f14775.js"><link rel="prefetch" href="/assets/js/28.7afb20e0.js"><link rel="prefetch" href="/assets/js/3.2479901d.js"><link rel="prefetch" href="/assets/js/30.5cd1972d.js"><link rel="prefetch" href="/assets/js/31.4cd3dfd6.js"><link rel="prefetch" href="/assets/js/32.8eaf2d9f.js"><link rel="prefetch" href="/assets/js/33.71e761e7.js"><link rel="prefetch" href="/assets/js/34.761eee2c.js"><link rel="prefetch" href="/assets/js/35.6dd74fa0.js"><link rel="prefetch" href="/assets/js/36.ac572cd7.js"><link rel="prefetch" href="/assets/js/37.7183c761.js"><link rel="prefetch" href="/assets/js/38.9ac94c8b.js"><link rel="prefetch" href="/assets/js/39.13de4603.js"><link rel="prefetch" href="/assets/js/4.14853dcd.js"><link rel="prefetch" href="/assets/js/40.6ac8dd39.js"><link rel="prefetch" href="/assets/js/41.2fb47fa7.js"><link rel="prefetch" href="/assets/js/42.9bb7ebd8.js"><link rel="prefetch" href="/assets/js/43.3a74ed6a.js"><link rel="prefetch" href="/assets/js/44.535cf951.js"><link rel="prefetch" href="/assets/js/45.56fac91b.js"><link rel="prefetch" href="/assets/js/46.c7323734.js"><link rel="prefetch" href="/assets/js/47.5f6abd5f.js"><link rel="prefetch" href="/assets/js/48.b8b122b3.js"><link rel="prefetch" href="/assets/js/49.e91b97b8.js"><link rel="prefetch" href="/assets/js/5.510e7b60.js"><link rel="prefetch" href="/assets/js/50.7cbf3300.js"><link rel="prefetch" href="/assets/js/51.d78456ea.js"><link rel="prefetch" href="/assets/js/52.a67d5dd8.js"><link rel="prefetch" href="/assets/js/6.3df49180.js"><link rel="prefetch" href="/assets/js/7.4b781894.js"><link rel="prefetch" href="/assets/js/8.40feba35.js"><link rel="prefetch" href="/assets/js/9.2f72d411.js">
    <link rel="stylesheet" href="/assets/css/2.styles.e26ea78c.css"><link rel="stylesheet" href="/assets/css/1.styles.de89d32b.css"><link rel="stylesheet" href="/assets/css/styles.0d1d678c.css"><link rel="stylesheet" href="/assets/css/10.styles.685e93e4.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div id="vuepress-theme-glitzma"><header class="header" style="background-size:cover;background-repeat:no-repeat;background-position:center;background-attachment:scroll;background-image:url(/assets/img/header-image-03.jpg);" data-v-e4a0ebe0><div data-v-6654f004 data-v-e4a0ebe0><nav class="navbar" data-v-6654f004><div class="container" data-v-6654f004><a href="/" class="router-link-active" data-v-6654f004><span class="navbar-site-name" data-v-6654f004>
          马明娟
        </span></a> <div class="navbar-toggler" data-v-6654f004><svg class="icon" style="font-size:1.2em;" data-v-6654f004 data-v-6654f004><title data-v-6654f004 data-v-6654f004>menu</title><use xlink:href="#icon-menu" data-v-6654f004 data-v-6654f004></use></svg></div> <div class="navbar-links" data-v-6654f004><a href="/" class="navbar-link" data-v-6654f004>
            Home
          </a><a href="/posts/" class="navbar-link router-link-active" data-v-6654f004>
            Search
          </a><a href="/custom-pages/" class="navbar-link" data-v-6654f004>
            About
          </a></div></div></nav> <div class="navbar-holder" style="display:none;" data-v-6654f004></div></div> <div class="banner" data-v-e2d7da12 data-v-e4a0ebe0 data-v-e4a0ebe0><div class="container" data-v-e2d7da12><div class="center" data-v-e2d7da12></div></div></div></header> <div class="container clearfix show-aside" data-v-0874e876 data-v-0874e876><main class="main" data-v-0874e876><div class="post" data-v-0874e876 data-v-0874e876><section class="post-meta main-div" data-v-12a4d4fc><section class="post-date clearfix" data-v-12a4d4fc><span class="create-date" data-v-12a4d4fc>
      发布于 : 2019-05-01
    </span> <span class="update-date" data-v-12a4d4fc>
      修改于 : 2022-07-09
    </span></section> <section class="post-links" data-v-12a4d4fc><a href="/posts/2019/08/26/regexp-learn.html" class="post-link" data-v-12a4d4fc>
      下一篇 : 学习正则的使用
    </a> <a href="/posts/2019/03/23/theme-guide-zh.html" class="post-link" data-v-12a4d4fc>
      上一篇 : 主题使用指南
    </a></section></section> <article class="main-div"><div class="post-content content__default"><h2 id="前端错误监控">前端错误监控</h2> <p>可以通过web vitals和LightHouse 监控</p> <h3 id="为什么做前端监控">为什么做前端监控</h3> <ul><li>更快发现问题和解决问题</li> <li>做产品的决策依据</li> <li>提高稳定性和用户体验</li> <li>为业务扩展提供更多可能性</li></ul> <h4 id="常见的异常">常见的异常</h4> <ul><li>js错误，js执行错误或者promise异常</li> <li>资源异常 script、link等资源加载异常</li> <li>接口错误 ajax或者fetch请求接口异常</li> <li>白屏或者空白页面</li></ul> <h4 id="用户体验方面">用户体验方面</h4> <ul><li>加载时间	各个阶段的加载时间</li> <li>TTFB(time to first byte)(首字节时间)	是指浏览器发起第一个请求到数据返回第一个字节所消耗的时间，这个时间包含了网络请求时间、后端处理时间</li> <li>FP(First Paint)(首次绘制)	首次绘制包括了任何用户自定义的背景绘制，它是将第一个像素点绘制到屏幕的时刻</li> <li>FCP(First Content Paint)(首次内容绘制)	首次内容绘制是浏览器将第一个DOM渲染到屏幕的时间,可以是任何文本、图像、SVG等的时间</li> <li><a href="https://docs.google.com/document/d/1BR94tJdZLsin5poeet0XoTW60M0SjvOJQttKT-JK8HI/view" target="_blank" rel="noopener noreferrer">FMP(First Meaningful paint)(首次有意义绘制)<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>	首次有意义绘制是页面可用性的量度标准</li> <li>FID(First Input Delay)(首次输入延迟)	用户首次和页面交互到页面响应交互的时间</li> <li><a href="https://wicg.github.io/largest-contentful-paint/" target="_blank" rel="noopener noreferrer">LCP	(Largest Contentful Paint)(最大内容渲染)<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>	代表在viewport中最大的页面元素加载的时间。<code>2.5s</code>以内是好的，2.5s到4s需要优化。</li> <li>DCL	(DomContentLoaded)(DOM加载完成)	当 HTML 文档被完全加载和解析完成之后,DOMContentLoaded 事件被触发，无需等待样式表、图像和子框架的完成加载</li> <li>L	(onLoad)	当依赖的资源全部加载完毕之后才会触发</li> <li>TTI	(Time to Interactive) 可交互时间	用于标记应用已进行视觉渲染并能可靠响应用户输入的时间点</li> <li>FID	First Input Delay(首次输入延迟)	用户首次和页面交互(单击链接，点击按钮等)到页面响应交互的时间。100ms以内是好的，100ms到300ms需要改善。</li> <li>TBT（Total blocking time）主线程累计阻塞时间</li> <li>CLS（Cummulative layout time）累计布局偏移，小于0.1是好的，0.1s到0.25s需要改善。</li> <li>卡顿	超过50ms的长任务。响应用户交互的响应时间如果大于100ms,用户就会感觉卡顿</li> <li><a href="https://w3c.github.io/paint-timing/" target="_blank" rel="noopener noreferrer">paint timing<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul> <h4 id="业务方面">业务方面</h4> <ul><li>PV	page view 即页面浏览量或点击量</li> <li>UV	指访问某个站点的不同IP地址的人数</li> <li>页面的停留时间	用户在每一个页面的停留时间</li> <li>用户行为记录</li></ul> <h3 id="常见的埋点方案">常见的埋点方案</h3> <p>前端监控流程包括：前端埋点 =&gt; 数据上报 =&gt; 分析和计算数据 将采集到的数据进行加工汇总 =&gt; 可视化展示 将数据按各种维度进行展示 =&gt; 监控报警 发现问题后按一定的条件触发报警</p> <p>常见的埋点方案包括：代码埋点、可视化埋点、无痕埋点</p> <h4 id="代码埋点">代码埋点</h4> <ul><li>代码埋点，就是以嵌入代码的形式进行埋点,比如需要监控用户的点击事件,会选择在用户点击时,插入一段代码，保存这个监听行为或者直接将监听行为以某一种数据格式直接传递给服务器端</li> <li>优点是可以在任意时刻，精确的发送或保存所需要的数据信息</li> <li>缺点是工作量较大</li></ul> <h4 id="可视化埋点">可视化埋点</h4> <ul><li>通过可视化交互的手段，代替代码埋点</li> <li>将业务代码和埋点代码分离，提供一个可视化交互的页面，输入为业务代码，通过这个可视化系统，可以在业务代码中自定义的增加埋点事件等等,最后输出的代码耦合了业务代码和埋点代码</li> <li>可视化埋点其实是用系统来代替手工插入埋点代码</li></ul> <h4 id="无痕埋点">无痕埋点</h4> <ul><li>前端的任意一个事件都被绑定一个标识，所有的事件都别记录下来</li> <li>通过定期上传记录文件,配合文件解析，解析出来我们想要的数据，并生成可视化报告供专业人员分析</li> <li>无痕埋点的优点是采集全量数据,不会出现漏埋和误埋等现象</li> <li>缺点是给数据传输和服务器增加压力，也无法灵活定制数据结构</li></ul> <h3 id="运行时错误">运行时错误</h3> <p>运行时错误的捕获方式</p> <ol><li>try catch</li> <li>window.onerror(0级dom事件，也可以用二级dom事件)，只能捕获即时错误</li></ol> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> tracker <span class="token keyword">from</span> <span class="token string">'./tracker'</span><span class="token punctuation">;</span> <span class="token comment">// 后面有写tracker.js</span>
<span class="token comment">// 捕获全局异常</span>

window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'error'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span><span class="token punctuation">{</span> <span class="token comment">// 监听全局未捕获的错误</span>
	console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'捕获'</span><span class="token punctuation">,</span> event<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">let</span> log <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>event<span class="token punctuation">.</span>target <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>event<span class="token punctuation">.</span>target<span class="token punctuation">.</span>src <span class="token operator">||</span> event<span class="token punctuation">.</span>target<span class="token punctuation">.</span>href<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 有src或者href，表示资源加载失败</span>
		log <span class="token operator">=</span> <span class="token punctuation">{</span>
			<span class="token literal-property property">kind</span><span class="token operator">:</span> <span class="token string">'stability'</span><span class="token punctuation">,</span><span class="token comment">// 稳定性指标</span>
			<span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'error'</span><span class="token punctuation">,</span><span class="token comment">// resource</span>
			<span class="token literal-property property">errorType</span><span class="token operator">:</span> <span class="token string">'resourceError'</span><span class="token punctuation">,</span>
			<span class="token literal-property property">filename</span><span class="token operator">:</span> event<span class="token punctuation">.</span>target<span class="token punctuation">.</span>src <span class="token operator">||</span> event<span class="token punctuation">.</span>target<span class="token punctuation">.</span>href<span class="token punctuation">,</span><span class="token comment">// 加载失败的资源</span>
			<span class="token literal-property property">tagName</span><span class="token operator">:</span> event<span class="token punctuation">.</span>target<span class="token punctuation">.</span>tagName<span class="token punctuation">,</span><span class="token comment">// 标签名</span>
			<span class="token literal-property property">timeStamp</span><span class="token operator">:</span> <span class="token function">formatTime</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>timeStamp<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token comment">// 时间</span>
			<span class="token literal-property property">selector</span><span class="token operator">:</span> <span class="token function">getSelector</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>path <span class="token operator">||</span> event<span class="token punctuation">.</span>target<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token comment">// 选择器</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
		log <span class="token operator">=</span> <span class="token punctuation">{</span>
			<span class="token string-property property">&quot;timestamp&quot;</span><span class="token operator">:</span> event<span class="token punctuation">.</span>timeStamp<span class="token punctuation">,</span><span class="token comment">// &quot;1590815288710&quot;,// 访问时间戳</span>
			<span class="token string-property property">&quot;kind&quot;</span><span class="token operator">:</span> <span class="token string">&quot;stability&quot;</span><span class="token punctuation">,</span><span class="token comment">// 大类</span>
			<span class="token string-property property">&quot;type&quot;</span><span class="token operator">:</span> event<span class="token punctuation">.</span>type<span class="token punctuation">,</span><span class="token comment">// &quot;error&quot;,// 小类</span>
			<span class="token string-property property">&quot;errorType&quot;</span><span class="token operator">:</span> <span class="token string">&quot;jsError&quot;</span><span class="token punctuation">,</span><span class="token comment">// js执行错误类型</span>
			<span class="token string-property property">&quot;message&quot;</span><span class="token operator">:</span> event<span class="token punctuation">.</span>message<span class="token punctuation">,</span> <span class="token comment">// &quot;Uncaught TypeError: Cannot set property 'error' of undefined&quot;,// 报错信息类型详情</span>
			<span class="token string-property property">&quot;filename&quot;</span><span class="token operator">:</span> event<span class="token punctuation">.</span>filename<span class="token punctuation">,</span><span class="token comment">// &quot;http://localhost:8080/&quot;,// 访问的文件名</span>
			<span class="token string-property property">&quot;position&quot;</span><span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>event<span class="token punctuation">.</span>lineno<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>event<span class="token punctuation">.</span>colno<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span><span class="token comment">// 行列信息</span>
			<span class="token string-property property">&quot;stack&quot;</span><span class="token operator">:</span> <span class="token function">getLines</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>error<span class="token punctuation">.</span>stack<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token comment">// &quot;btnClick (http://localhost:8080/:20:39)^HTMLInputElement.onclick (http://localhost:8080/:14:72)&quot;,// 堆栈信息</span>
			<span class="token string-property property">&quot;selector&quot;</span><span class="token operator">:</span> lastEvent<span class="token operator">?</span><span class="token function">getSelector</span><span class="token punctuation">(</span>lastEvent<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token string">''</span><span class="token punctuation">,</span><span class="token comment">// &quot;HTML BODY #container .content INPUT&quot;// 选择器</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	
	tracker<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>log<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token comment">// 这里一定是true才会捕获。换成冒泡的话是无法捕获到异常的.true代表在捕获阶段调用,false代表在冒泡阶段捕获</span>

<span class="token keyword">function</span> <span class="token function">getLines</span><span class="token punctuation">(</span><span class="token parameter">stack</span><span class="token punctuation">)</span><span class="token punctuation">{</span> <span class="token comment">// 获取栈信息</span>
	<span class="token keyword">return</span> stack<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">'\n'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token operator">=&gt;</span>item<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^\s+at\s+</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">'^'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">getSelector</span><span class="token punctuation">(</span><span class="token parameter">path</span><span class="token punctuation">)</span><span class="token punctuation">{</span> <span class="token comment">// 获取选择器</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span> <span class="token comment">// 如果是个对象的话转成数组</span>
		<span class="token keyword">var</span> paths <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
		<span class="token keyword">var</span> element <span class="token operator">=</span> pathsOrTarget<span class="token punctuation">;</span>
		<span class="token keyword">while</span> <span class="token punctuation">(</span>element<span class="token punctuation">)</span> <span class="token punctuation">{</span>
				paths<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span><span class="token punctuation">;</span>
				element <span class="token operator">=</span> element<span class="token punctuation">.</span>parentNode<span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		path <span class="token operator">=</span> paths<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> path<span class="token punctuation">.</span><span class="token function">reverse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token parameter">element</span><span class="token operator">=&gt;</span>element<span class="token punctuation">{</span>
		<span class="token keyword">return</span> element <span class="token operator">!==</span> document <span class="token operator">&amp;&amp;</span> element <span class="token operator">!==</span> window<span class="token punctuation">;</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">element</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
		<span class="token keyword">let</span> selector <span class="token operator">=</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>element<span class="token punctuation">.</span>id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>element<span class="token punctuation">.</span>nodeName<span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">#</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>element<span class="token punctuation">.</span>id<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>element<span class="token punctuation">.</span>className <span class="token operator">&amp;&amp;</span> <span class="token keyword">typeof</span> element<span class="token punctuation">.</span>className <span class="token operator">===</span> <span class="token string">&quot;string&quot;</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
			<span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>element<span class="token punctuation">.</span>nodeName<span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>element<span class="token punctuation">.</span>className<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
			selector <span class="token operator">=</span> element<span class="token punctuation">.</span>nodeName<span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">return</span> selector
	<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">&quot; &quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token comment">// 当Promise 被 reject 且没有 reject 处理器的时候，会触发 unhandledrejection 事件</span>
window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'unhandledrejection'</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> <span class="token comment">// 捕获promise的异常</span>
	<span class="token keyword">let</span> lastEvent <span class="token operator">=</span> <span class="token function">getLastEvent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">let</span> message <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">;</span>
	<span class="token keyword">let</span> line <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token keyword">let</span> column <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token keyword">let</span> file <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">;</span>
	<span class="token keyword">let</span> stack <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">;</span>
	<span class="token keyword">let</span> reason <span class="token operator">=</span> event<span class="token punctuation">.</span>reason<span class="token punctuation">;</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> event<span class="token punctuation">.</span>reason <span class="token operator">===</span> <span class="token string">'string'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			message <span class="token operator">=</span> event<span class="token punctuation">.</span>reason<span class="token punctuation">;</span>
	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> event<span class="token punctuation">.</span>reason <span class="token operator">===</span> <span class="token string">'object'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			message <span class="token operator">=</span> event<span class="token punctuation">.</span>reason<span class="token punctuation">.</span>message<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> reason <span class="token operator">===</span> <span class="token string">'object'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 是一个错误对象</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>reason<span class="token punctuation">.</span>stack<span class="token punctuation">)</span> <span class="token punctuation">{</span>
					<span class="token keyword">var</span> matchResult <span class="token operator">=</span> reason<span class="token punctuation">.</span>stack<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">at\s+(.+):(\d+):(\d+)</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token keyword">if</span> <span class="token punctuation">(</span>matchResult<span class="token punctuation">)</span> <span class="token punctuation">{</span>
							file <span class="token operator">=</span> matchResult<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
							line <span class="token operator">=</span> matchResult<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
							column <span class="token operator">=</span> matchResult<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
					<span class="token punctuation">}</span>
					stack <span class="token operator">=</span> <span class="token function">getLines</span><span class="token punctuation">(</span>reason<span class="token punctuation">.</span>stack<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	tracker<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token comment">// 未捕获的promise错误</span>
			<span class="token literal-property property">kind</span><span class="token operator">:</span> <span class="token string">'stability'</span><span class="token punctuation">,</span><span class="token comment">// 稳定性指标 大类型</span>
			<span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'error'</span><span class="token punctuation">,</span><span class="token comment">// jsError</span>
			<span class="token literal-property property">errorType</span><span class="token operator">:</span> <span class="token string">'promiseError'</span><span class="token punctuation">,</span><span class="token comment">// unhandledrejection</span>
			<span class="token literal-property property">message</span><span class="token operator">:</span> message<span class="token punctuation">,</span><span class="token comment">// 标签名</span>
			<span class="token literal-property property">filename</span><span class="token operator">:</span> file<span class="token punctuation">,</span>
			<span class="token literal-property property">position</span><span class="token operator">:</span> line <span class="token operator">+</span> <span class="token string">':'</span> <span class="token operator">+</span> column<span class="token punctuation">,</span><span class="token comment">// 行列</span>
			stack<span class="token punctuation">,</span>
			<span class="token literal-property property">selector</span><span class="token operator">:</span> lastEvent <span class="token operator">?</span> <span class="token function">getSelector</span><span class="token punctuation">(</span>lastEvent<span class="token punctuation">.</span>path <span class="token operator">||</span> lastEvent<span class="token punctuation">.</span>target<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token string">''</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token boolean">true</span><span class="token punctuation">)</span>

<span class="token comment">// 存储最后触发的事件</span>
<span class="token keyword">var</span> lastEvent <span class="token punctuation">;</span>
<span class="token punctuation">[</span><span class="token string">'click'</span><span class="token punctuation">,</span><span class="token string">'touchstart'</span><span class="token punctuation">,</span><span class="token string">'mousedown'</span><span class="token punctuation">,</span><span class="token string">'keydown'</span><span class="token punctuation">,</span><span class="token string">'mouseover'</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">eventType</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
	document<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span>eventType<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
		lastEvent <span class="token operator">=</span> event<span class="token punctuation">;</span>
	<span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{</span>
		<span class="token literal-property property">capture</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">// 捕获阶段</span>
		<span class="token literal-property property">passive</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">// 默认不阻止默认事件</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// tracker.js</span>
<span class="token keyword">let</span> host <span class="token operator">=</span> <span class="token string">'cn-beijing.log.aliyuncs.com'</span><span class="token punctuation">;</span> <span class="token comment">// 主机名 北京的域名</span>
<span class="token keyword">let</span> project <span class="token operator">=</span> <span class="token string">'mingjuanmonitor'</span><span class="token punctuation">;</span> <span class="token comment">// 项目名</span>
<span class="token keyword">let</span> logstore <span class="token operator">=</span> <span class="token string">'mingjuanmonitor-store'</span><span class="token punctuation">;</span> <span class="token comment">// 存储名</span>
<span class="token keyword">var</span> userAgent <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'user-agent'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 获取其他信息</span>
<span class="token keyword">function</span> <span class="token function">getExtraData</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">title</span><span class="token operator">:</span> document<span class="token punctuation">.</span>title<span class="token punctuation">,</span>
        <span class="token literal-property property">url</span><span class="token operator">:</span> location<span class="token punctuation">.</span>href<span class="token punctuation">,</span>
        <span class="token literal-property property">timestamp</span><span class="token operator">:</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token literal-property property">userAgent</span><span class="token operator">:</span> userAgent<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>navigator<span class="token punctuation">.</span>userAgent<span class="token punctuation">)</span><span class="token punctuation">.</span>name
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">class</span> <span class="token class-name">SendTracker</span> <span class="token punctuation">{</span>
	<span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>url <span class="token operator">=</span>  <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">http://</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>project<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>host<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/logstores/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>logstore<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/track</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span><span class="token punctuation">;</span> <span class="token comment">// 上报路径</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>xhr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">XMLHttpRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token function">send</span><span class="token punctuation">(</span><span class="token parameter">data <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token keyword">let</span> extraData <span class="token operator">=</span> <span class="token function">getExtraData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">let</span> logs <span class="token operator">=</span> <span class="token punctuation">{</span>
			<span class="token operator">...</span>extraData<span class="token punctuation">,</span>
			<span class="token operator">...</span>data<span class="token punctuation">,</span>
		<span class="token punctuation">}</span>

		<span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">let</span> key <span class="token keyword">in</span> logs<span class="token punctuation">)</span><span class="token punctuation">{</span>
			<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">typeof</span> logs<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token string">'number'</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
				logs<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>logs<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>

		<span class="token keyword">let</span> body <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
			<span class="token literal-property property">___logs___</span><span class="token operator">:</span> <span class="token punctuation">[</span>logs<span class="token punctuation">]</span>
		<span class="token punctuation">}</span><span class="token punctuation">)</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>xhr<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">'POST'</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>url<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>xhr<span class="token punctuation">.</span><span class="token function">setRequestHeader</span><span class="token punctuation">(</span><span class="token string">&quot;Content-Type&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;application/json;charset=UTF-8&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>xhr<span class="token punctuation">.</span><span class="token function">setRequestHeader</span><span class="token punctuation">(</span><span class="token string">'x-log-apiversion'</span><span class="token punctuation">,</span> <span class="token string">'0.6.0'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>xhr<span class="token punctuation">.</span><span class="token function">setRequestHeader</span><span class="token punctuation">(</span><span class="token string">'x-log-bodyrawsize'</span><span class="token punctuation">,</span> body<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>xhr<span class="token punctuation">.</span><span class="token function-variable function">onload</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">&gt;=</span> <span class="token number">200</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">&lt;=</span> <span class="token number">300</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">==</span> <span class="token number">304</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
				callback <span class="token operator">&amp;&amp;</span> <span class="token function">callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>xhr<span class="token punctuation">.</span><span class="token function-variable function">onerror</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'error'</span><span class="token punctuation">,</span> error<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>xhr<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>body<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">new</span> <span class="token class-name">SendTracker</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>当Promise 被 reject 且没有 reject 处理器的时候，会触发 unhandledrejection 事件；这可能发生在 window 下，但也可能发生在 Worker 中。 这对于调试回退错误处理非常有用。</p> <h3 id="性能监控">性能监控</h3> <ol start="2"><li><a href="https://developer.mozilla.org/zh-CN/docs/Web/API/PerformanceTiming" target="_blank" rel="noopener noreferrer">PerformanceTiming<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>对象包含延迟相关的性能信息</li> <li><a href="https://developer.mozilla.org/zh-CN/docs/Web/API/PerformanceObserver/observe" target="_blank" rel="noopener noreferrer">PerformanceObserver.observe<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>方法用于观察传入的参数中指定的性能条目类型的集合。当记录一个指定类型的性能条目时，性能监测对象的回调函数将会被调用</li></ol> <ul><li><a href="https://developer.mozilla.org/zh-CN/docs/Web/API/Window/DOMContentLoaded_event" target="_blank" rel="noopener noreferrer">DOMContentLoaded含义<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://docs.google.com/document/d/1BR94tJdZLsin5poeet0XoTW60M0SjvOJQttKT-JK8HI/view#" target="_blank" rel="noopener noreferrer">FMP(First Meaningful paint)(首次有意义绘制)<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">timing</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">let</span> <span class="token constant">FMP</span><span class="token punctuation">,</span> <span class="token constant">LCP</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>PerformanceObserver<span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token keyword">new</span> <span class="token class-name">PerformanceObserver</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">entryList<span class="token punctuation">,</span> observer</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
		<span class="token comment">// dom加上setAttribute('elementtiming','meaningful'); 才会触发表示有意义的绘制</span>
		<span class="token keyword">let</span> perfEntries <span class="token operator">=</span> entryList<span class="token punctuation">.</span><span class="token function">getEntries</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token constant">FMP</span> <span class="token operator">=</span> perfEntries<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
		observer<span class="token punctuation">.</span><span class="token function">disconnect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 不再观察</span>
		<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">observe</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">entryTypes</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'element'</span><span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 观察页面中有意义的元素</span>
		<span class="token keyword">new</span> <span class="token class-name">PerformanceObserver</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">entryList<span class="token punctuation">,</span> observer</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
			<span class="token keyword">const</span> perfEntries <span class="token operator">=</span> entryList<span class="token punctuation">.</span><span class="token function">getEntries</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">const</span> lastEntry <span class="token operator">=</span> perfEntries<span class="token punctuation">[</span>perfEntries<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
			<span class="token constant">LCP</span> <span class="token operator">=</span> lastEntry<span class="token punctuation">;</span>
			observer<span class="token punctuation">.</span><span class="token function">disconnect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">observe</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">entryTypes</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'largest-contentful-paint'</span><span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 最大有内容的条目绘制 </span>
		<span class="token keyword">new</span> <span class="token class-name">PerformanceObserver</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">entryList<span class="token punctuation">,</span> observer</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">let</span> lastEvent <span class="token operator">=</span> <span class="token function">getLastEvent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">const</span> firstInput <span class="token operator">=</span> entryList<span class="token punctuation">.</span><span class="token function">getEntries</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>firstInput<span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token keyword">let</span> inputDelay <span class="token operator">=</span> firstInput<span class="token punctuation">.</span>processingStart <span class="token operator">-</span> firstInput<span class="token punctuation">.</span>startTime<span class="token punctuation">;</span><span class="token comment">// 处理延迟。processingStart开始处理时间，startTime点击的时间，差值为延迟时间</span>
				<span class="token keyword">let</span> duration <span class="token operator">=</span> firstInput<span class="token punctuation">.</span>duration<span class="token punctuation">;</span><span class="token comment">// 处理持续时间</span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span>firstInput <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">||</span> duration <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
					tracker<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
						<span class="token literal-property property">kind</span><span class="token operator">:</span> <span class="token string">'experience'</span><span class="token punctuation">,</span>
						<span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'firstInputDelay'</span><span class="token punctuation">,</span> <span class="token comment">// 首次输入延迟</span>
						<span class="token literal-property property">inputDelay</span><span class="token operator">:</span> inputDelay <span class="token operator">?</span> <span class="token function">formatTime</span><span class="token punctuation">(</span>inputDelay<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
						<span class="token literal-property property">duration</span><span class="token operator">:</span> duration <span class="token operator">?</span> <span class="token function">formatTime</span><span class="token punctuation">(</span>duration<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
						<span class="token literal-property property">startTime</span><span class="token operator">:</span> firstInput<span class="token punctuation">.</span>startTime<span class="token punctuation">,</span>
						<span class="token literal-property property">selector</span><span class="token operator">:</span> lastEvent <span class="token operator">?</span> <span class="token function">getSelector</span><span class="token punctuation">(</span>lastEvent<span class="token punctuation">.</span>path <span class="token operator">||</span> lastEvent<span class="token punctuation">.</span>target<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token string">''</span>
					<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span>
			observer<span class="token punctuation">.</span><span class="token function">disconnect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">observe</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'first-input'</span><span class="token punctuation">,</span> <span class="token literal-property property">buffered</span><span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 第一次有意义的交互FID</span>
	<span class="token punctuation">}</span>

	<span class="token function">onload</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
			<span class="token keyword">const</span> <span class="token punctuation">{</span>
				fetchStart<span class="token punctuation">,</span>
				connectStart<span class="token punctuation">,</span>
				connectEnd<span class="token punctuation">,</span>
				requestStart<span class="token punctuation">,</span>
				responseStart<span class="token punctuation">,</span>
				responseEnd<span class="token punctuation">,</span>
				domLoading<span class="token punctuation">,</span>
				domInteractive<span class="token punctuation">,</span>
				domContentLoadedEventStart<span class="token punctuation">,</span>
				domContentLoadedEventEnd<span class="token punctuation">,</span>
				loadEventStart <span class="token punctuation">}</span> <span class="token operator">=</span> performance<span class="token punctuation">.</span>timing<span class="token punctuation">;</span>
			tracker<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
				<span class="token literal-property property">kind</span><span class="token operator">:</span> <span class="token string">'experience'</span><span class="token punctuation">,</span> <span class="token comment">// 用户体验指标</span>
				<span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'timing'</span><span class="token punctuation">,</span> <span class="token comment">// 统计每个阶段的时间</span>
				<span class="token literal-property property">connectTime</span><span class="token operator">:</span> connectEnd <span class="token operator">-</span> connectStart<span class="token punctuation">,</span><span class="token comment">// TCP连接耗时</span>
				<span class="token literal-property property">ttfbTime</span><span class="token operator">:</span> responseStart <span class="token operator">-</span> requestStart<span class="token punctuation">,</span><span class="token comment">// ttfb首字节到达时间</span>
				<span class="token literal-property property">responseTime</span><span class="token operator">:</span> responseEnd <span class="token operator">-</span> responseStart<span class="token punctuation">,</span><span class="token comment">// Response响应耗时</span>
				<span class="token literal-property property">parseDOMTime</span><span class="token operator">:</span> loadEventStart <span class="token operator">-</span> domLoading<span class="token punctuation">,</span><span class="token comment">// DOM解析渲染耗时</span>
				<span class="token literal-property property">domContentLoadedTime</span><span class="token operator">:</span> domContentLoadedEventEnd <span class="token operator">-</span> domContentLoadedEventStart<span class="token punctuation">,</span><span class="token comment">// DOMContentLoaded事件回调耗时（dom完成时间）</span>
				<span class="token literal-property property">timeToInteractive</span><span class="token operator">:</span> domInteractive <span class="token operator">-</span> fetchStart<span class="token punctuation">,</span><span class="token comment">// 首次可交互时间</span>
				<span class="token literal-property property">loadTime</span><span class="token operator">:</span> loadEventStart <span class="token operator">-</span> fetchStart<span class="token comment">// 完整的加载时间</span>
			<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


			<span class="token keyword">const</span> <span class="token constant">FP</span> <span class="token operator">=</span> performance<span class="token punctuation">.</span><span class="token function">getEntriesByName</span><span class="token punctuation">(</span><span class="token string">'first-paint'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
			<span class="token keyword">const</span> <span class="token constant">FCP</span> <span class="token operator">=</span> performance<span class="token punctuation">.</span><span class="token function">getEntriesByName</span><span class="token punctuation">(</span><span class="token string">'first-contentful-paint'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
			console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'FP'</span><span class="token punctuation">,</span> <span class="token constant">FP</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'FCP'</span><span class="token punctuation">,</span> <span class="token constant">FCP</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'FMP'</span><span class="token punctuation">,</span> <span class="token constant">FMP</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// dom加上setAttribute('elementtiming','meaningful'); 才会触发表示有意义的绘制</span>
			console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'LCP'</span><span class="token punctuation">,</span> <span class="token constant">LCP</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			tracker<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
				<span class="token literal-property property">kind</span><span class="token operator">:</span> <span class="token string">'experience'</span><span class="token punctuation">,</span> <span class="token comment">// 用户体验指标</span>
				<span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'paint'</span><span class="token punctuation">,</span> <span class="token comment">// 统计每个阶段时间</span>
				<span class="token literal-property property">firstPaint</span><span class="token operator">:</span> <span class="token constant">FP</span> <span class="token operator">?</span> <span class="token function">formatTime</span><span class="token punctuation">(</span><span class="token constant">FP</span><span class="token punctuation">.</span>startTime<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
				<span class="token literal-property property">firstContentPaint</span><span class="token operator">:</span> <span class="token constant">FCP</span> <span class="token operator">?</span> <span class="token function">formatTime</span><span class="token punctuation">(</span><span class="token constant">FCP</span><span class="token punctuation">.</span>startTime<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
				<span class="token literal-property property">firstMeaningfulPaint</span><span class="token operator">:</span> <span class="token constant">FMP</span> <span class="token operator">?</span> <span class="token function">formatTime</span><span class="token punctuation">(</span><span class="token constant">FMP</span><span class="token punctuation">.</span>startTime<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
				<span class="token literal-property property">largestContentfulPaint</span><span class="token operator">:</span> <span class="token constant">LCP</span> <span class="token operator">?</span> <span class="token function">formatTime</span><span class="token punctuation">(</span><span class="token constant">LCP</span><span class="token punctuation">.</span>renderTime <span class="token operator">||</span> <span class="token constant">LCP</span><span class="token punctuation">.</span>loadTime<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token number">0</span>
			<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	functin <span class="token function">formatTime</span><span class="token punctuation">(</span><span class="token parameter">time</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>time<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">&quot;.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
	<span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre></div><h3 id="白屏上报">白屏上报</h3> <p>影响白屏时间的因素： 网络，服务端性能，前端页面结构设计			
影响首屏时间的因素： 白屏时间，资源下载执行时间</p> <p>白屏是通过判断某行某列N个点处的dom元素是否为包裹元素来判断页面中是否有内容。如果没有元素则进行异常上报。</p> <ul><li>screen 返回当前window的screen对象,返回当前渲染窗口中和屏幕有关的属性</li> <li>innerWidth 只读的 Window 属性 innerWidth 返回以像素为单位的窗口的内部宽度</li> <li>innerHeight 窗口的内部高度(布局视口)的高度</li> <li>elementsFromPoint方法可以获取到当前视口内指定坐标处，由里到外排列的所有元素</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">blankScreen</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> wrapperSelectors <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'body'</span><span class="token punctuation">,</span> <span class="token string">'html'</span><span class="token punctuation">,</span> <span class="token string">'#container'</span><span class="token punctuation">,</span> <span class="token string">'.content'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> emptyPoints <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">function</span> <span class="token function">isWrapper</span><span class="token punctuation">(</span><span class="token parameter">element</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> selector <span class="token operator">=</span> <span class="token function">getSelector</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>wrapperSelectors<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>selector<span class="token punctuation">)</span> <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            emptyPoints<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token function">onload</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> xElements<span class="token punctuation">,</span> yElements<span class="token punctuation">;</span>
        <span class="token keyword">debugger</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> <span class="token number">9</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            xElements <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">elementsFromPoint</span><span class="token punctuation">(</span>window<span class="token punctuation">.</span>innerWidth <span class="token operator">*</span> i <span class="token operator">/</span> <span class="token number">10</span><span class="token punctuation">,</span> window<span class="token punctuation">.</span>innerHeight <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">)</span>
            yElements <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">elementsFromPoint</span><span class="token punctuation">(</span>window<span class="token punctuation">.</span>innerWidth <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">,</span> window<span class="token punctuation">.</span>innerHeight <span class="token operator">*</span> i <span class="token operator">/</span> <span class="token number">10</span><span class="token punctuation">)</span>
            <span class="token function">isWrapper</span><span class="token punctuation">(</span>xElements<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">isWrapper</span><span class="token punctuation">(</span>yElements<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>emptyPoints <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 空折点个数大于等于0个时上报</span>
            <span class="token keyword">let</span> centerElements <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">elementsFromPoint</span><span class="token punctuation">(</span>window<span class="token punctuation">.</span>innerWidth <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">,</span> window<span class="token punctuation">.</span>innerHeight <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">)</span>
            tracker<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
                <span class="token literal-property property">kind</span><span class="token operator">:</span> <span class="token string">'stability'</span><span class="token punctuation">,</span> <span class="token comment">// 稳定性</span>
                <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'blank'</span><span class="token punctuation">,</span> <span class="token comment">// 白屏</span>
                <span class="token literal-property property">emptyPoints</span><span class="token operator">:</span> <span class="token string">&quot;&quot;</span> <span class="token operator">+</span> emptyPoints<span class="token punctuation">,</span> <span class="token comment">// 埋了多少点</span>
                <span class="token literal-property property">screen</span><span class="token operator">:</span> window<span class="token punctuation">.</span>screen<span class="token punctuation">.</span>width <span class="token operator">+</span> <span class="token string">&quot;x&quot;</span> <span class="token operator">+</span> window<span class="token punctuation">.</span>screen<span class="token punctuation">.</span>height<span class="token punctuation">,</span> <span class="token comment">// 分辨率</span>
                <span class="token literal-property property">viewPoint</span><span class="token operator">:</span> window<span class="token punctuation">.</span>innerWidth <span class="token operator">+</span> <span class="token string">'x'</span> <span class="token operator">+</span> window<span class="token punctuation">.</span>innerHeight<span class="token punctuation">,</span>
                <span class="token literal-property property">selector</span><span class="token operator">:</span> <span class="token function">getSelector</span><span class="token punctuation">(</span>centerElements<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// 选择器</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">//screen.width  屏幕的宽度   screen.height 屏幕的高度</span>
<span class="token comment">//window.innerWidth 去除工具条与滚动条的窗口宽度 window.innerHeight 去除工具条与滚动条的窗口高度</span>


<span class="token keyword">function</span> <span class="token function">onload</span><span class="token punctuation">(</span><span class="token parameter">callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>document<span class="token punctuation">.</span>readyState <span class="token operator">===</span> <span class="token string">'complete'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'load'</span><span class="token punctuation">,</span> callback<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">getSelector</span><span class="token punctuation">(</span><span class="token parameter">element</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> selector<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>element<span class="token punctuation">.</span>id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        selector <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">#</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>element<span class="token punctuation">.</span>id<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>element<span class="token punctuation">.</span>className <span class="token operator">&amp;&amp;</span> <span class="token keyword">typeof</span> element<span class="token punctuation">.</span>className <span class="token operator">===</span> <span class="token string">'string'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        selector <span class="token operator">=</span> <span class="token string">'.'</span> <span class="token operator">+</span> element<span class="token punctuation">.</span>className<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">' '</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token operator">!</span><span class="token operator">!</span>item <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">'.'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        selector <span class="token operator">=</span> element<span class="token punctuation">.</span>nodeName<span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> selector<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre></div><h3 id="跨域的js运行错误捕获">跨域的js运行错误捕获</h3> <p>只能捕获错误但不能拿到具体信息</p> <ol><li>在script标签增加crossorigin属性(在客户端做)</li> <li>设置js资源响应头Access-Control-Allow-Origin: * （这里可以是*也可以是域名。需要在服务端做）</li></ol> <h3 id="错误上报">错误上报</h3> <ol><li>采用ajax通信方式上报（一般不用这种方式）</li> <li>利用Image对象上报（如google的gaa，国内的cnzz都是image方式上报）</li> <li>监听请求进行上报时可以重写xmlHttpRequest的方式，重写send函数，执行完上报，在用老的send函数call执行发送请求</li></ol> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">injectXHR</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> XMLHttpRequest <span class="token operator">=</span> window<span class="token punctuation">.</span>XMLHttpRequest<span class="token punctuation">;</span>
    <span class="token keyword">let</span> oldOpen <span class="token operator">=</span> <span class="token class-name">XMLHttpRequest</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>open<span class="token punctuation">;</span>
    <span class="token class-name">XMLHttpRequest</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">open</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">method<span class="token punctuation">,</span> url<span class="token punctuation">,</span> async<span class="token punctuation">,</span> username<span class="token punctuation">,</span> password</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>url<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">logstores</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>url<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">sockjs</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>logData <span class="token operator">=</span> <span class="token punctuation">{</span>
                method<span class="token punctuation">,</span> url<span class="token punctuation">,</span> async<span class="token punctuation">,</span> username<span class="token punctuation">,</span> password
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token function">oldOpen</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> arguments<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">let</span> oldSend <span class="token operator">=</span> <span class="token class-name">XMLHttpRequest</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>send<span class="token punctuation">;</span>
    <span class="token keyword">let</span> start<span class="token punctuation">;</span>
    <span class="token class-name">XMLHttpRequest</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">send</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">body</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>logData<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            start <span class="token operator">=</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">let</span> <span class="token function-variable function">handler</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">type</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                <span class="token keyword">let</span> duration <span class="token operator">=</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> start<span class="token punctuation">;</span>
                <span class="token keyword">let</span> status <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>status<span class="token punctuation">;</span>
                <span class="token keyword">let</span> statusText <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>statusText<span class="token punctuation">;</span>
                tracker<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token comment">//未捕获的promise错误</span>
                    <span class="token literal-property property">kind</span><span class="token operator">:</span> <span class="token string">'stability'</span><span class="token punctuation">,</span><span class="token comment">//稳定性指标</span>
                    <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'xhr'</span><span class="token punctuation">,</span><span class="token comment">//xhr</span>
                    <span class="token literal-property property">eventType</span><span class="token operator">:</span> type<span class="token punctuation">,</span><span class="token comment">//load error abort</span>
                    <span class="token literal-property property">pathname</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>logData<span class="token punctuation">.</span>url<span class="token punctuation">,</span><span class="token comment">//接口的url地址</span>
                    <span class="token literal-property property">status</span><span class="token operator">:</span> status <span class="token operator">+</span> <span class="token string">&quot;-&quot;</span> <span class="token operator">+</span> statusText<span class="token punctuation">,</span>
                    <span class="token literal-property property">duration</span><span class="token operator">:</span> <span class="token string">&quot;&quot;</span> <span class="token operator">+</span> duration<span class="token punctuation">,</span><span class="token comment">//接口耗时</span>
                    <span class="token literal-property property">response</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>response <span class="token operator">?</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>response<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span>
                    <span class="token literal-property property">params</span><span class="token operator">:</span> body <span class="token operator">||</span> <span class="token string">''</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'load'</span><span class="token punctuation">,</span> <span class="token function">handler</span><span class="token punctuation">(</span><span class="token string">'load'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'error'</span><span class="token punctuation">,</span> <span class="token function">handler</span><span class="token punctuation">(</span><span class="token string">'error'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'abort'</span><span class="token punctuation">,</span> <span class="token function">handler</span><span class="token punctuation">(</span><span class="token string">'abort'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token function">oldSend</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> arguments<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>// 利用image方式更简单，一行就可以轻松实现上报</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Image</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>src<span class="token operator">=</span><span class="token string">&quot;http://xxx.com/abc?r=yyy&quot;</span>
</code></pre></div><h3 id="优化">优化</h3> <p>dns预解析</p> <div class="language- extra-class"><pre class="language-text"><code>&lt;link rel=&quot;dsn-prefetch&quot; href=&quot;//example.com&quot;&gt;
</code></pre></div><p>预连接,提前建立连接</p> <div class="language- extra-class"><pre class="language-text"><code>&lt;link rel=&quot;preconnect&quot; href=&quot;//example.com&quot;&gt;
</code></pre></div><p>预获取,获取后不会立即执行</p> <div class="language- extra-class"><pre class="language-text"><code>&lt;link rel=&quot;prefetch&quot; href=&quot;//example.com/script.js&quot; as=&quot;script&quot;&gt;
</code></pre></div><p>预渲染,除了会获取还会执行页面进行预渲染</p> <div class="language- extra-class"><pre class="language-text"><code>&lt;link rel=&quot;prerender&quot; href=&quot;//example.com/performance.html&quot;&gt;
</code></pre></div><p>preload的优先级比prefetch更高，浏览器遇到preload后会立刻进行预获取，并存在内存中，资源获取不会影响parse与load事件触发，直到遇到该资源的使用标签时才会触发。</p> <div class="language- extra-class"><pre class="language-text"><code>&lt;link rel=&quot;preload&quot; href=&quot;//example.com/example.css&quot; as=&quot;style&quot;&gt;
</code></pre></div><h4 id="prefetch、preload、async、defer对比">prefetch、preload、async、defer对比</h4></div></article> <section class="post-meta main-div" data-v-12a4d4fc><section class="post-date clearfix" data-v-12a4d4fc><span class="create-date" data-v-12a4d4fc>
      发布于 : 2019-05-01
    </span> <span class="update-date" data-v-12a4d4fc>
      修改于 : 2022-07-09
    </span></section> <section class="post-links" data-v-12a4d4fc><a href="/posts/2019/08/26/regexp-learn.html" class="post-link" data-v-12a4d4fc>
      下一篇 : 学习正则的使用
    </a> <a href="/posts/2019/03/23/theme-guide-zh.html" class="post-link" data-v-12a4d4fc>
      上一篇 : 主题使用指南
    </a></section></section> <div id="post-comments" class="main-div"><!----></div></div></main> <aside class="aside" data-v-0874e876><div class="info-card main-div" data-v-2bd66a30 data-v-0874e876><div class="info-card-header" data-v-2bd66a30><img src="https://www.mamingjuan.cn/assets/img/avatar.jpeg" alt="Glitr" class="info-avatar" data-v-2bd66a30></div> <div class="info-card-body" data-v-2bd66a30><section class="info-nickname" data-v-2bd66a30>
      Glitr
    </section> <section class="info-desc" data-v-2bd66a30>Enjoy coding,<br/>Enjoy life:)</section> <section class="info-contact" data-v-2bd66a30><section data-v-2bd66a30><span title="Beijing City, China" data-v-2bd66a30 data-v-2bd66a30><svg class="icon" style="font-size:1em;" data-v-2bd66a30 data-v-2bd66a30><title data-v-2bd66a30 data-v-2bd66a30>Beijing City, China</title><use xlink:href="#icon-location" data-v-2bd66a30 data-v-2bd66a30></use></svg><span class="info-text" data-v-2bd66a30 data-v-2bd66a30>
          Beijing City, China
        </span></span></section> <section data-v-2bd66a30><span title="Secrecy" data-v-2bd66a30 data-v-2bd66a30><svg class="icon" style="font-size:1em;" data-v-2bd66a30 data-v-2bd66a30><title data-v-2bd66a30 data-v-2bd66a30>Secrecy</title><use xlink:href="#icon-organization" data-v-2bd66a30 data-v-2bd66a30></use></svg><span class="info-text" data-v-2bd66a30 data-v-2bd66a30>
          Secrecy
        </span></span></section> <section data-v-2bd66a30><a href="mailto:glitteringma@gmail.com" title="glitteringma@gmail.com" data-v-2bd66a30 data-v-2bd66a30><svg class="icon" style="font-size:1em;" data-v-2bd66a30 data-v-2bd66a30><title data-v-2bd66a30 data-v-2bd66a30>glitteringma@gmail.com</title><use xlink:href="#icon-email" data-v-2bd66a30 data-v-2bd66a30></use></svg><span class="info-text" data-v-2bd66a30 data-v-2bd66a30>
          glitteringma@gmail.com
        </span></a></section></section></div> <div class="info-card-footer" data-v-2bd66a30><section class="info-sns clearfix" data-v-2bd66a30><a href="https://github.com/happy760690" target="_blank" class="sns-link" data-v-2bd66a30><span title="GitHub: glitzma" class="sns-icon" data-v-2bd66a30 data-v-2bd66a30><svg class="icon" style="font-size:1.5em;" data-v-2bd66a30 data-v-2bd66a30><title data-v-2bd66a30 data-v-2bd66a30>GitHub: glitzma</title><use xlink:href="#icon-github" data-v-2bd66a30 data-v-2bd66a30></use></svg></span></a></section></div></div> <div class="post-nav-card main-div" style="position:relative;top:0;width:0px;" data-v-0874e876><div class="post-nav-contents"><svg class="icon"><title>book</title><use xlink:href="#icon-book"></use></svg> <span>文章目录</span> <div class="post-nav-toc"><ul><li><a href="/posts/2019/05/01/error-log.html#前端错误监控">前端错误监控</a><ul><li><a href="/posts/2019/05/01/error-log.html#为什么做前端监控">为什么做前端监控</a></li><li><a href="/posts/2019/05/01/error-log.html#常见的埋点方案">常见的埋点方案</a></li><li><a href="/posts/2019/05/01/error-log.html#运行时错误">运行时错误</a></li><li><a href="/posts/2019/05/01/error-log.html#性能监控">性能监控</a></li><li><a href="/posts/2019/05/01/error-log.html#白屏上报">白屏上报</a></li><li><a href="/posts/2019/05/01/error-log.html#跨域的js运行错误捕获">跨域的js运行错误捕获</a></li><li><a href="/posts/2019/05/01/error-log.html#错误上报">错误上报</a></li><li><a href="/posts/2019/05/01/error-log.html#优化">优化</a></li></ul></li></ul></div></div> <div class="post-nav-comments"><svg class="icon"><title>comment</title><use xlink:href="#icon-comment"></use></svg> <a href="/posts/2019/05/01/error-log.html#post-comments">
      评论
    </a></div></div></aside></div> <footer class="footer" data-v-ede90b42><p class="sns-links" data-v-ede90b42><a href="https://github.com/happy760690" target="_blank" class="sns-link" data-v-ede90b42><span title="GitHub: glitzma" class="sns-icon" data-v-ede90b42 data-v-ede90b42><svg class="icon" style="font-size:25px;" data-v-ede90b42 data-v-ede90b42><title data-v-ede90b42 data-v-ede90b42>GitHub: glitzma</title><use xlink:href="#icon-github" data-v-ede90b42 data-v-ede90b42></use></svg></span></a></p> <div class="copyright" data-v-ede90b42>
    © 2014 –
    <span itemprop="copyrightYear" data-v-ede90b42>2023</span> <span class="post-meta-divider" data-v-ede90b42>|</span> <span itemprop="copyrightHolder" class="author" data-v-ede90b42>Glitr</span></div></footer></div><div class="global-ui"><!----><!----></div></div>
    <script src="/assets/js/app~748942c6.e26ea78c.js" defer></script><script src="/assets/js/10.685e93e4.js" defer></script><script src="/assets/js/29.58c20ca7.js" defer></script><script src="/assets/js/app~2a42e354.de89d32b.js" defer></script><script src="/assets/js/app~1f20a385.0d1d678c.js" defer></script>
  </body>
</html>
