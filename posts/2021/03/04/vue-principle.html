<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>vue一些思考 | 马明娟</title>
    <meta name="generator" content="VuePress 1.8.2">
    
    <meta name="description" content="This is my blog">
    
    <link rel="preload" href="/assets/css/0.styles.7ae9fe33.css" as="style"><link rel="preload" href="/assets/js/app~d0ae3f07.7ae9fe33.js" as="script"><link rel="preload" href="/assets/css/styles.43f6a87c.css" as="style"><link rel="preload" href="/assets/js/app~db300d2f.43f6a87c.js" as="script"><link rel="preload" href="/assets/css/9.styles.d80ec364.css" as="style"><link rel="preload" href="/assets/js/9.d80ec364.js" as="script"><link rel="preload" href="/assets/js/43.c424591e.js" as="script"><link rel="prefetch" href="/assets/css/10.styles.06714614.css"><link rel="prefetch" href="/assets/css/2.styles.c30b94c6.css"><link rel="prefetch" href="/assets/css/3.styles.78e857d7.css"><link rel="prefetch" href="/assets/css/4.styles.c6dd9a10.css"><link rel="prefetch" href="/assets/css/5.styles.a4cf2d4b.css"><link rel="prefetch" href="/assets/css/6.styles.a463c4a0.css"><link rel="prefetch" href="/assets/css/7.styles.a4f00c88.css"><link rel="prefetch" href="/assets/css/8.styles.e03eae99.css"><link rel="prefetch" href="/assets/js/10.06714614.js"><link rel="prefetch" href="/assets/js/11.42360893.js"><link rel="prefetch" href="/assets/js/12.9f882609.js"><link rel="prefetch" href="/assets/js/13.2968004d.js"><link rel="prefetch" href="/assets/js/14.997d4d9d.js"><link rel="prefetch" href="/assets/js/15.9a1cff14.js"><link rel="prefetch" href="/assets/js/16.a08a4d85.js"><link rel="prefetch" href="/assets/js/17.cd2757aa.js"><link rel="prefetch" href="/assets/js/18.da85c0e1.js"><link rel="prefetch" href="/assets/js/19.24e158f5.js"><link rel="prefetch" href="/assets/js/2.c30b94c6.js"><link rel="prefetch" href="/assets/js/20.7c2536fb.js"><link rel="prefetch" href="/assets/js/21.cc3dd757.js"><link rel="prefetch" href="/assets/js/22.d938a8f2.js"><link rel="prefetch" href="/assets/js/23.7a6361f9.js"><link rel="prefetch" href="/assets/js/24.659ddf4b.js"><link rel="prefetch" href="/assets/js/25.8af94c70.js"><link rel="prefetch" href="/assets/js/26.6d7e92d3.js"><link rel="prefetch" href="/assets/js/27.fadaee63.js"><link rel="prefetch" href="/assets/js/28.5c72fff4.js"><link rel="prefetch" href="/assets/js/29.f469b58b.js"><link rel="prefetch" href="/assets/js/3.78e857d7.js"><link rel="prefetch" href="/assets/js/30.513f826d.js"><link rel="prefetch" href="/assets/js/31.b2394dec.js"><link rel="prefetch" href="/assets/js/32.039a18f0.js"><link rel="prefetch" href="/assets/js/33.cc6aa218.js"><link rel="prefetch" href="/assets/js/34.14b5948c.js"><link rel="prefetch" href="/assets/js/35.a976251a.js"><link rel="prefetch" href="/assets/js/36.842d5ddf.js"><link rel="prefetch" href="/assets/js/37.504f3e6b.js"><link rel="prefetch" href="/assets/js/38.0df49f45.js"><link rel="prefetch" href="/assets/js/39.6d3334f8.js"><link rel="prefetch" href="/assets/js/4.c6dd9a10.js"><link rel="prefetch" href="/assets/js/40.85aeb0ed.js"><link rel="prefetch" href="/assets/js/41.8d146200.js"><link rel="prefetch" href="/assets/js/42.361bd65a.js"><link rel="prefetch" href="/assets/js/44.3327afe0.js"><link rel="prefetch" href="/assets/js/45.efcf1686.js"><link rel="prefetch" href="/assets/js/46.dea3e576.js"><link rel="prefetch" href="/assets/js/47.84876b51.js"><link rel="prefetch" href="/assets/js/48.193dab24.js"><link rel="prefetch" href="/assets/js/49.9d6913b4.js"><link rel="prefetch" href="/assets/js/5.a4cf2d4b.js"><link rel="prefetch" href="/assets/js/6.a463c4a0.js"><link rel="prefetch" href="/assets/js/7.a4f00c88.js"><link rel="prefetch" href="/assets/js/8.e03eae99.js">
    <link rel="stylesheet" href="/assets/css/0.styles.7ae9fe33.css"><link rel="stylesheet" href="/assets/css/styles.43f6a87c.css"><link rel="stylesheet" href="/assets/css/9.styles.d80ec364.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div id="vuepress-theme-glitzma"><header class="header" style="background-size:cover;background-repeat:no-repeat;background-position:center;background-attachment:scroll;background-image:url(/assets/img/header-image-02.jpg);" data-v-e4a0ebe0><div data-v-6654f004 data-v-e4a0ebe0><nav class="navbar" data-v-6654f004><div class="container" data-v-6654f004><a href="/" class="router-link-active" data-v-6654f004><span class="navbar-site-name" data-v-6654f004>
          马明娟
        </span></a> <div class="navbar-toggler" data-v-6654f004><svg class="icon" style="font-size:1.2em;" data-v-6654f004 data-v-6654f004><title data-v-6654f004 data-v-6654f004>menu</title><use xlink:href="#icon-menu" data-v-6654f004 data-v-6654f004></use></svg></div> <div class="navbar-links" data-v-6654f004><a href="/" class="navbar-link" data-v-6654f004>
            Home
          </a><a href="/posts/" class="navbar-link router-link-active" data-v-6654f004>
            Search
          </a><a href="/custom-pages/" class="navbar-link" data-v-6654f004>
            About
          </a></div></div></nav> <div class="navbar-holder" style="display:none;" data-v-6654f004></div></div> <div class="banner" data-v-e2d7da12 data-v-e4a0ebe0 data-v-e4a0ebe0><div class="container" data-v-e2d7da12><div class="center" data-v-e2d7da12></div></div></div></header> <div class="container clearfix show-aside" data-v-0874e876 data-v-0874e876><main class="main" data-v-0874e876><div class="post" data-v-0874e876 data-v-0874e876><section class="post-meta main-div" data-v-12a4d4fc><section class="post-date clearfix" data-v-12a4d4fc><span class="create-date" data-v-12a4d4fc>
      发布于 : 2021-03-04
    </span> <span class="update-date" data-v-12a4d4fc>
      修改于 : 2021-12-02
    </span></section> <section class="post-links" data-v-12a4d4fc><a href="/posts/2021/03/09/webpack.html" class="post-link" data-v-12a4d4fc>
      下一篇 : webpack应用总结一
    </a> <a href="/posts/2021/03/02/vue-basics.html" class="post-link" data-v-12a4d4fc>
      上一篇 : vue基础知识
    </a></section></section> <article class="main-div"><div class="post-content content__default"><div><ul><li><a href="/posts/2021/03/04/vue-principle.html#vue常见原理">vue常见原理</a><ul><li><a href="/posts/2021/03/04/vue-principle.html#模板编译过程概述">模板编译过程概述</a></li><li><a href="/posts/2021/03/04/vue-principle.html#响应式">响应式</a></li><li><a href="/posts/2021/03/04/vue-principle.html#vdom">vdom</a></li><li><a href="/posts/2021/03/04/vue-principle.html#diff算法概述">diff算法概述</a></li><li><a href="/posts/2021/03/04/vue-principle.html#组件的渲染更新过程">组件的渲染更新过程</a></li><li><a href="/posts/2021/03/04/vue-principle.html#将props传递子组件">将props传递子组件</a></li><li><a href="/posts/2021/03/04/vue-principle.html#hash模式">hash模式</a></li><li><a href="/posts/2021/03/04/vue-principle.html#hisotry模式">hisotry模式</a></li></ul></li></ul></div> <h2 id="vue常见原理">vue常见原理</h2> <ol><li>编译原理</li> <li>响应式原理，依赖收集</li> <li>组件化开发（贯穿vue的流程）</li> <li>diff算法</li></ol> <h3 id="模板编译过程概述">模板编译过程概述</h3> <ol><li>将模板编译成抽象语法树
<a href="https://astexplorer.net/" target="_blank" rel="noopener noreferrer">抽象语法树是什么样的可以在这里查看<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>选择vue选项即可
解析模板通过正则表达式获取标签、属性、表达式等，当遇到开始标签放入栈中，遇到结束标签则出栈，拼接成AST抽象语法树，然后通过优化器遍历AST进行标记静态节点，主要用来做虚拟DOM的渲染优化。</li> <li>通过generate根据抽象语法树生成代码生成render函数vue template compiler将模板编译为render函数，执行render 函数生成vnode。基于vnode进行patch和diff。</li></ol> <p>使用vue-loader在开发环境下编译模板。</p> <p>width函数</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> obj <span class="token operator">=</span> <span class="token punctuation">{</span> a<span class="token operator">:</span> <span class="token number">100</span><span class="token punctuation">,</span> b<span class="token operator">:</span> <span class="token number">200</span><span class="token punctuation">}</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>obj<span class="token punctuation">.</span>a<span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>obj<span class="token punctuation">.</span>b<span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>obj<span class="token punctuation">.</span>c<span class="token punctuation">)</span> <span class="token comment">// undefined</span>

<span class="token keyword">with</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 会报错</span>
<span class="token punctuation">}</span>

<span class="token comment">// with语法改变自由变量的查找规则，当做obj属性来查找，如果调用了查找不到的属性会报错</span>
<span class="token comment">// with打破了作用域的规则，易读性变差</span>
</code></pre></div><p>引入<code>vue-template-compiler</code> 编译字符串模板 在index.js中写入模板和输出，在terminal中执行node index.js即可查看输出</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 插值</span>
<span class="token keyword">const</span> template <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;p&gt;{{message}}&lt;/p&gt;</span><span class="token template-punctuation string">`</span></span>
<span class="token comment">// 编译后的结果是</span>
<span class="token comment">// with(this){return _c('p',[_v(_s(message))])}</span>
<span class="token comment">// 替换成函数</span>
<span class="token comment">// with(this){return createElement('p',[createTextVNode(toString(message))])}</span>

<span class="token comment">// // 表达式</span>
<span class="token comment">// const template = `&lt;p&gt;{{flag ? message : 'no message found'}}&lt;/p&gt;`</span>
<span class="token comment">// 编译后的结果是</span>
<span class="token comment">// // with(this){return _c('p',[_v(_s(flag ? message : 'no message found'))])}</span>

<span class="token comment">// // 属性和动态属性</span>
<span class="token comment">// const template = `</span>
<span class="token comment">//     &lt;div id=&quot;div1&quot; class=&quot;container&quot;&gt;</span>
<span class="token comment">//         &lt;img :src=&quot;imgUrl&quot;/&gt;</span>
<span class="token comment">//     &lt;/div&gt;</span>
<span class="token comment">// `</span>
<span class="token comment">// 编译后的结果是</span>
<span class="token comment">// with(this){return _c('div',</span>
<span class="token comment">//      {staticClass:&quot;container&quot;,attrs:{&quot;id&quot;:&quot;div1&quot;}},</span>
<span class="token comment">//      [</span>
<span class="token comment">//          _c('img',{attrs:{&quot;src&quot;:imgUrl}})])}</span>

<span class="token comment">// // 条件</span>
<span class="token comment">// const template = `</span>
<span class="token comment">//     &lt;div&gt;</span>
<span class="token comment">//         &lt;p v-if=&quot;flag === 'a'&quot;&gt;A&lt;/p&gt;</span>
<span class="token comment">//         &lt;p v-else&gt;B&lt;/p&gt;</span>
<span class="token comment">//     &lt;/div&gt;</span>
<span class="token comment">// `</span>
<span class="token comment">// with(this){return _c('div',[(flag === 'a')?_c('p',[_v(&quot;A&quot;)]):_c('p',[_v(&quot;B&quot;)])])}</span>

<span class="token comment">// 循环</span>
<span class="token comment">// const template = `</span>
<span class="token comment">//     &lt;ul&gt;</span>
<span class="token comment">//         &lt;li v-for=&quot;item in list&quot; :key=&quot;item.id&quot;&gt;{{item.title}}&lt;/li&gt;</span>
<span class="token comment">//     &lt;/ul&gt;</span>
<span class="token comment">// `</span>
<span class="token comment">// with(this){return _c('ul',_l((list),function(item){return _c('li',{key:item.id},[_v(_s(item.title))])}),0)}</span>

<span class="token comment">// 事件</span>
<span class="token comment">// const template = `</span>
<span class="token comment">//     &lt;button @click=&quot;clickHandler&quot;&gt;submit&lt;/button&gt;</span>
<span class="token comment">// `</span>
<span class="token comment">// with(this){return _c('button',{on:{&quot;click&quot;:clickHandler}},[_v(&quot;submit&quot;)])}</span>

<span class="token comment">// v-model</span>
<span class="token comment">// const template = `&lt;input type=&quot;text&quot; v-model=&quot;name&quot;&gt;`</span>
<span class="token comment">// 主要看 input 事件</span>
<span class="token comment">// with(this){</span>
<span class="token comment">//    return _c('input',</span>
<span class="token comment">//    {</span>
<span class="token comment">//      directives: [{name:&quot;model&quot;,rawName:&quot;v-model&quot;,value:(name),expression:&quot;name&quot;}],</span>
<span class="token comment">//      attrs:{&quot;type&quot;:&quot;text&quot;},domProps:{&quot;value&quot;:(name)},</span>
<span class="token comment">//      on:{&quot;input&quot;:function($event){if($event.target.composing)return;name=$event.target.value}}})</span>
<span class="token comment">// }</span>

<span class="token comment">// 在模板渲染阶段v-model已经被挂载上了onInput的事件来更新数据，每次更新触发渲染</span>


<span class="token comment">// 编译</span>
<span class="token keyword">const</span> res <span class="token operator">=</span> compiler<span class="token punctuation">.</span><span class="token function">compile</span><span class="token punctuation">(</span>template<span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span>render<span class="token punctuation">)</span>


<span class="token comment">// // 从 vue 源码中找到缩写函数的含义</span>
<span class="token comment">// function installRenderHelpers (target) {</span>
<span class="token comment">//     target._o = markOnce;</span>
<span class="token comment">//     target._n = toNumber;</span>
<span class="token comment">//     target._s = toString;</span>
<span class="token comment">//     target._l = renderList;</span>
<span class="token comment">//     target._t = renderSlot;</span>
<span class="token comment">//     target._q = looseEqual;</span>
<span class="token comment">//     target._i = looseIndexOf;</span>
<span class="token comment">//     target._m = renderStatic;</span>
<span class="token comment">//     target._f = resolveFilter;</span>
<span class="token comment">//     target._k = checkKeyCodes;</span>
<span class="token comment">//     target._b = bindObjectProps;</span>
<span class="token comment">//     target._v = createTextVNode;</span>
<span class="token comment">//     target._e = createEmptyVNode;</span>
<span class="token comment">//     target._u = resolveScopedSlots;</span>
<span class="token comment">//     target._g = bindObjectListeners;</span>
<span class="token comment">//     target._d = bindDynamicKeys;</span>
<span class="token comment">//     target._p = prependModifier;</span>
<span class="token comment">// }</span>
<span class="token comment">// this._c = (a, b, c, d) =&gt; createElement(contextVm, a, b, c, d, needNormalization)</span>
</code></pre></div><h3 id="响应式">响应式</h3> <p>实现原理：<br>
通过<code>Object.defineProperty</code>来监听数据的改变，当数据变更后触发set更新视图。当遇到object对象时继续深度遍历实现对象的深度监听，当遇到数组时重新定义数组对象，扩展新的方法，实现数据的监听</p> <p><code>Object.defineProperty</code>的缺点：</p> <ul><li>深度监听需要一次性递归到底，计算量大。如果数据太大会卡。</li> <li>无法监听新增属性/删除属性（可通过vue.set, vue.delete解决）</li> <li>无法原生监听数组，需要特殊处理</li></ul> <div class="language-js extra-class"><pre class="language-js"><code>
<span class="token comment">// 触发更新视图</span>
<span class="token keyword">function</span> <span class="token function">updateView</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'视图更新'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// 重新定义数组原型</span>
<span class="token keyword">const</span> oldArrayProperty <span class="token operator">=</span> <span class="token class-name">Array</span><span class="token punctuation">.</span>prototype
<span class="token comment">// 创建新对象，原型指向 oldArrayProperty ，再扩展新的方法不会影响原型</span>
<span class="token keyword">const</span> arrProto <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>oldArrayProperty<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">[</span><span class="token string">'push'</span><span class="token punctuation">,</span> <span class="token string">'pop'</span><span class="token punctuation">,</span> <span class="token string">'shift'</span><span class="token punctuation">,</span> <span class="token string">'unshift'</span><span class="token punctuation">,</span> <span class="token string">'splice'</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">methodName</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    arrProto<span class="token punctuation">[</span>methodName<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">updateView</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 触发视图更新</span>
        oldArrayProperty<span class="token punctuation">[</span>methodName<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token operator">...</span>arguments<span class="token punctuation">)</span>
        <span class="token comment">// Array.prototype.push.call(this, ...arguments)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// 重新定义属性，监听起来</span>
<span class="token keyword">function</span> <span class="token function">defineReactive</span><span class="token punctuation">(</span><span class="token parameter">target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 深度监听</span>
    <span class="token function">observer</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>

    <span class="token comment">// 核心 API</span>
    Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> <span class="token punctuation">{</span>
        <span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> value
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token function">set</span><span class="token punctuation">(</span>newValue<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>newValue <span class="token operator">!==</span> value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// 深度监听</span>
                <span class="token function">observer</span><span class="token punctuation">(</span>newValue<span class="token punctuation">)</span>

                <span class="token comment">// 设置新值</span>
                <span class="token comment">// 注意，value 一直在闭包中，此处设置完之后，再 get 时也是会获取最新的值</span>
                value <span class="token operator">=</span> newValue

                <span class="token comment">// 触发更新视图</span>
                <span class="token function">updateView</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// 监听对象属性</span>
<span class="token keyword">function</span> <span class="token function">observer</span><span class="token punctuation">(</span><span class="token parameter">target</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> target <span class="token operator">!==</span> <span class="token string">'object'</span> <span class="token operator">||</span> target <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 不是对象或数组</span>
        <span class="token keyword">return</span> target
    <span class="token punctuation">}</span>

    <span class="token comment">// 污染全局的 Array 原型</span>
    <span class="token comment">// Array.prototype.push = function () {</span>
    <span class="token comment">//     updateView()</span>
    <span class="token comment">//     ...</span>
    <span class="token comment">// }</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        target<span class="token punctuation">.</span>__proto__ <span class="token operator">=</span> arrProto
    <span class="token punctuation">}</span>

    <span class="token comment">// 重新定义各个属性（for in 也可以遍历数组）</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> key <span class="token keyword">in</span> target<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">defineReactive</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> target<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 准备数据</span>
<span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token punctuation">{</span>
    name<span class="token operator">:</span> <span class="token string">'zhangsan'</span><span class="token punctuation">,</span>
    age<span class="token operator">:</span> <span class="token number">20</span><span class="token punctuation">,</span>
    info<span class="token operator">:</span> <span class="token punctuation">{</span>
        address<span class="token operator">:</span> <span class="token string">'北京'</span> <span class="token comment">// 需要深度监听</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    nums<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">,</span> <span class="token number">30</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span>

<span class="token comment">// 监听数据</span>
<span class="token function">observer</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>

<span class="token comment">// 测试</span>
<span class="token comment">// data.name = 'lisi'</span>
<span class="token comment">// data.age = 21</span>
<span class="token comment">// // console.log('age', data.age)</span>
<span class="token comment">// data.x = '100' // 新增属性，监听不到 —— 所以有 Vue.set</span>
<span class="token comment">// delete data.name // 删除属性，监听不到 —— 所有已 Vue.delete</span>
<span class="token comment">// data.info.address = '上海' // 深度监听</span>
data<span class="token punctuation">.</span>nums<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span> <span class="token comment">// 监听数组</span>

</code></pre></div><p>vue2.x</p> <ul><li>核心api - object.defineProperty</li> <li>在监听对象需要深度遍历和监听数组时需要对数组属性做特殊处理，处理数组数据重新定义数组原型触发视图更新</li> <li>复杂对象的深度监听会有问题，因为处理监听时需要递归到底，一次性计算量大</li> <li>无法监听新增、删除属性（vue.set、vue.delete）</li></ul> <p>vue3</p> <ul><li>核心api proxy 、reflect</li> <li>深度监听性能更好</li> <li>可监听 新增、删除属性</li> <li>可监听数组变化</li> <li>proxy可规避object.defineProperty的问题，但proxy无法兼容所有浏览器</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// proxy创建响应式</span>
<span class="token keyword">function</span> <span class="token function">reactive</span><span class="token punctuation">(</span><span class="token parameter">target <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> target <span class="token operator">!==</span> <span class="token string">'object'</span> <span class="token operator">||</span> target <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 不是对象或数组，则返回</span>
        <span class="token keyword">return</span> target
    <span class="token punctuation">}</span>

    <span class="token comment">// 代理配置</span>
    <span class="token keyword">const</span> proxyConf <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 只处理本身（非原型的）属性</span>
            <span class="token keyword">const</span> ownKeys <span class="token operator">=</span> Reflect<span class="token punctuation">.</span><span class="token function">ownKeys</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>ownKeys<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'get'</span><span class="token punctuation">,</span> key<span class="token punctuation">)</span> <span class="token comment">// 监听</span>
            <span class="token punctuation">}</span>
    
            <span class="token keyword">const</span> result <span class="token operator">=</span> Reflect<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span>
        
            <span class="token comment">// 深度监听</span>
            <span class="token comment">// 性能如何提升的？</span>
            <span class="token keyword">return</span> <span class="token function">reactive</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token function">set</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> val<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 重复的数据，不处理</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>val <span class="token operator">===</span> target<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token boolean">true</span>
            <span class="token punctuation">}</span>
    
            <span class="token keyword">const</span> ownKeys <span class="token operator">=</span> Reflect<span class="token punctuation">.</span><span class="token function">ownKeys</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>ownKeys<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'已有的 key'</span><span class="token punctuation">,</span> key<span class="token punctuation">)</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'新增的 key'</span><span class="token punctuation">,</span> key<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">const</span> result <span class="token operator">=</span> Reflect<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> val<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'set'</span><span class="token punctuation">,</span> key<span class="token punctuation">,</span> val<span class="token punctuation">)</span>
            <span class="token comment">// console.log('result', result) // true</span>
            <span class="token keyword">return</span> result <span class="token comment">// 是否设置成功</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token function">deleteProperty</span><span class="token punctuation">(</span><span class="token parameter">target<span class="token punctuation">,</span> key</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">const</span> result <span class="token operator">=</span> Reflect<span class="token punctuation">.</span><span class="token function">deleteProperty</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">)</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'delete property'</span><span class="token punctuation">,</span> key<span class="token punctuation">)</span>
            <span class="token comment">// console.log('result', result) // true</span>
            <span class="token keyword">return</span> result <span class="token comment">// 是否删除成功</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 生成代理对象</span>
    <span class="token keyword">const</span> observed <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> proxyConf<span class="token punctuation">)</span>
    <span class="token keyword">return</span> observed
<span class="token punctuation">}</span>

<span class="token comment">// 测试数据</span>
<span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token punctuation">{</span>
    name<span class="token operator">:</span> <span class="token string">'zhangsan'</span><span class="token punctuation">,</span>
    age<span class="token operator">:</span> <span class="token number">20</span><span class="token punctuation">,</span>
    info<span class="token operator">:</span> <span class="token punctuation">{</span>
        city<span class="token operator">:</span> <span class="token string">'beijing'</span><span class="token punctuation">,</span>
        a<span class="token operator">:</span> <span class="token punctuation">{</span>
            b<span class="token operator">:</span> <span class="token punctuation">{</span>
                c<span class="token operator">:</span> <span class="token punctuation">{</span>
                    d<span class="token operator">:</span> <span class="token punctuation">{</span>
                        e<span class="token operator">:</span> <span class="token number">100</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> proxyData <span class="token operator">=</span> <span class="token function">reactive</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>

</code></pre></div><h3 id="vdom">vdom</h3> <p>vdom是用js模拟dom结构，计算出最小的变更，操作dom</p> <p>为什么会有vdom？</p> <ul><li>正常的dom操作非常耗费性能，以前用jQuery操作dom全靠手动调整很费力。容易出错，不易于维护。</li> <li>当程序有了一定的复杂度，想减少计算次数比较难，用js描述dom节点，计算最小的变更再操作dom性能更高。</li> <li>vdom可以实现数据驱动视图，控制dom操作</li></ul> <div class="language-html extra-class"><pre class="language-html"><code><span class="token comment">&lt;!-- html --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>div1<span class="token punctuation">&quot;</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>container<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>vdom<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ul</span> <span class="token special-attr"><span class="token attr-name">style</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span><span class="token value css language-css"><span class="token property">font-size</span><span class="token punctuation">:</span>20px</span><span class="token punctuation">&quot;</span></span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">&gt;</span></span>a<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ul</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 翻译成vdom</span>
<span class="token punctuation">{</span>
    tag<span class="token operator">:</span> <span class="token string">'div'</span><span class="token punctuation">,</span>
    props<span class="token operator">:</span> <span class="token punctuation">{</span>
        className<span class="token operator">:</span> <span class="token string">'container'</span><span class="token punctuation">,</span>
        id<span class="token operator">:</span> <span class="token string">'div1'</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    children<span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span>
            tag<span class="token operator">:</span> <span class="token string">'p'</span><span class="token punctuation">,</span>
            children<span class="token operator">:</span> <span class="token string">'vdom'</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
            tag<span class="token operator">:</span> <span class="token string">'ul'</span><span class="token punctuation">,</span>
            props<span class="token operator">:</span> <span class="token punctuation">{</span>
                style<span class="token operator">:</span> <span class="token string">'font-size:20px'</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            children<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>
                tag<span class="token operator">:</span> <span class="token string">'li'</span><span class="token punctuation">,</span>
                children<span class="token operator">:</span> <span class="token string">'a'</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">]</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="diff算法概述">diff算法概述</h3> <p>下面是snabbdom的实现原理</p> <ul><li>diff算法是vdom的核心部分。</li> <li>diff算法是一个比较广泛的概念，如：linux diff、git diff</li> <li>两个js对象也可以做diff，两个树也能做diff</li> <li>vue dom diff主要是同一层级做比较，tag不同则直接删除掉重建，不再深入比较，tag与key相同则认为是相同节点(sameVnode的条件)。</li> <li>不使用key的dom更新时直接删除重新建，如果使用key可以通过判断key与tag的匹配度来确认保留还是新建。当在patch中确定为相同的vnode后会执行patchVnode</li> <li>patchVnode。新旧都有children进行updateChildren。新旧children是否有值，旧的有，新的无则删除节点（revmoeVnodes）。如果新有旧无，则新建(addVnodes)</li> <li>updateChildren 规则是 开始和开始对比，结束和结束对比，开始和结束对比，结束和开始对比。如果都未命中，用新节点的key能否对应旧节点的某个key，没对就上建新节点，对就上判断tag是否相同，不相同时创建新节点，相同时patchVnode。 这里面体现了key的重要性。</li></ul> <h3 id="组件的渲染更新过程">组件的渲染更新过程</h3> <ol><li>初次渲染</li></ol> <ul><li>解析模板为render函数</li> <li>绑定响应式，通过getter setter 监听data属性</li> <li>执行render函数，生成vnode， 然后patch（elem,vnode)</li></ul> <div class="custom-block tip"><p class="custom-block-title">注</p> <p>执行render函数会触发getter</p></div> <ol start="2"><li>更新过程</li></ol> <ul><li>修改data触发setter（此前已被收集监听的getter）</li> <li>重新执行render函数，成生newVnode</li> <li>patch（vnode,newVnode)</li></ul> <p>流程图</p> <p>在render函数执行时会touch触发data中的getter，触发后会收集依赖（触发了哪个变量的getter，就会观察哪个变量），一旦修改data的时候触发re-render，然后重新渲染，重新生成virtual dom tree
<img width="70%" src="/assets/img/update-component.png" alt="update-component-process"></p> <ol start="3"><li>异步渲染</li></ol> <ul><li>$nextTick待dom渲染完再回调。</li> <li>页面渲染时会将data的修改做整合，多次data修改只会渲染一次。</li> <li>减少dom操作次数，提高性能。</li></ul> <div class="custom-block tip"><p class="custom-block-title">注</p> <p>注： ajax请求要放到mounted中。vue本身不支持ajax请求，需要使用vue-resource、axios等插件实现。一个组件的created比mounted早调用不了几微秒。放到created性能提高不了多少，而且等异步渲染的时候，create可能被中途打断，中断之后渲染又要重做一遍，在created中做ajax调用，代码里只有一次调用，但实际上可能是n次调用。如果将ajax调用放到mounted阶段，不会有重复的调用，更合适。</p></div> <h3 id="将props传递子组件">将props传递子组件</h3> <p><code>&lt;User v-bind=&quot;$Props&quot;/&gt;</code></p> <p>因为在React的的高阶组件用的时候，最好将props全部传递给调用的父组件。所以vue这里也提一下。</p> <h3 id="hash模式">hash模式</h3> <ul><li>hash变化会触发浏览器的跳转，但不会刷新页面</li> <li>hash变化永远不会提交到服务端</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// hash 变化，包括：</span>
<span class="token comment">// a. JS 修改 url</span>
<span class="token comment">// b. 手动修改 url 的 hash</span>
<span class="token comment">// c. 浏览器前进、后退</span>
window<span class="token punctuation">.</span><span class="token function-variable function">onhashchange</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'old url'</span><span class="token punctuation">,</span> event<span class="token punctuation">.</span>oldURL<span class="token punctuation">)</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'new url'</span><span class="token punctuation">,</span> event<span class="token punctuation">.</span>newURL<span class="token punctuation">)</span>

    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'hash:'</span><span class="token punctuation">,</span> location<span class="token punctuation">.</span>hash<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// 页面初次加载，获取 hash</span>
document<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'DOMContentLoaded'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'hash:'</span><span class="token punctuation">,</span> location<span class="token punctuation">.</span>hash<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// JS 修改 url</span>
document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'btn1'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'click'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    location<span class="token punctuation">.</span>href <span class="token operator">=</span> <span class="token string">'#/user'</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="hisotry模式">hisotry模式</h3> <p>history跳转时不刷新页面，主要通过window.pushState和window.onpopState来实现</p> <p>因为对于所有路径都会返回 index.html 文件。为了避免这种情况，你应该在 Vue 应用里面覆盖所有的路由情况，然后在给出一个 404 页面。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 页面初次加载获取hash</span>
document<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'DOMContentLoaded'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'loaded'</span><span class="token punctuation">,</span>location<span class="token punctuation">.</span>pathname<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// 打开一个新的路由</span>
<span class="token comment">// 【注意】用 pushState 方式，浏览器不会刷新页面</span>
document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'btn1'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'click'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> state <span class="token operator">=</span> <span class="token punctuation">{</span> name<span class="token operator">:</span> <span class="token string">'page1'</span> <span class="token punctuation">}</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'切换路由到'</span><span class="token punctuation">,</span> <span class="token string">'page1'</span><span class="token punctuation">)</span>
    history<span class="token punctuation">.</span><span class="token function">pushState</span><span class="token punctuation">(</span>state<span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">,</span> <span class="token string">'page1'</span><span class="token punctuation">)</span> <span class="token comment">// 重要！！</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// 监听浏览器前进、后退</span>
window<span class="token punctuation">.</span><span class="token function-variable function">onpopstate</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> <span class="token comment">// 重要！！</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'onpopstate'</span><span class="token punctuation">,</span> event<span class="token punctuation">.</span>state<span class="token punctuation">,</span> location<span class="token punctuation">.</span>pathname<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// 每次请求服务器都要保证返回index.html页面，然后端端通过onpopstate来控制和监听页面跳到</span>
<span class="token comment">// 哪里才不会出现页面丢失的现象</span>
<span class="token comment">// 需要 server 端配合，可参考</span>
<span class="token comment">// https://router.vuejs.org/zh/guide/essentials/history-mode.html#%E5%90%8E%E7%AB%AF%E9%85%8D%E7%BD%AE%E4%BE%8B%E5%AD%90</span>


</code></pre></div><p>在vue中实现vue-router需要通过组件的install方法，在方法里面可能通过调用object.defineProperty注册全局$route。通过Vue.component注册routerLink和routerView组件。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">import</span> View <span class="token keyword">from</span> <span class="token string">'./components/view'</span>
<span class="token keyword">import</span> Link <span class="token keyword">from</span> <span class="token string">'./components/link'</span>

<span class="token keyword">export</span> <span class="token keyword">let</span> _Vue

<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">install</span> <span class="token punctuation">(</span><span class="token parameter">Vue</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>install<span class="token punctuation">.</span>installed <span class="token operator">&amp;&amp;</span> _Vue <span class="token operator">===</span> Vue<span class="token punctuation">)</span> <span class="token keyword">return</span>
  install<span class="token punctuation">.</span>installed <span class="token operator">=</span> <span class="token boolean">true</span>

  _Vue <span class="token operator">=</span> Vue

  <span class="token keyword">const</span> <span class="token function-variable function">isDef</span> <span class="token operator">=</span> <span class="token parameter">v</span> <span class="token operator">=&gt;</span> v <span class="token operator">!==</span> <span class="token keyword">undefined</span>

  <span class="token keyword">const</span> <span class="token function-variable function">registerInstance</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">vm<span class="token punctuation">,</span> callVal</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> i <span class="token operator">=</span> vm<span class="token punctuation">.</span>$options<span class="token punctuation">.</span>_parentVnode
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isDef</span><span class="token punctuation">(</span>i <span class="token operator">=</span> i<span class="token punctuation">.</span>data<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isDef</span><span class="token punctuation">(</span>i <span class="token operator">=</span> i<span class="token punctuation">.</span>registerRouteInstance<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">i</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> callVal<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  Vue<span class="token punctuation">.</span><span class="token function">mixin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token function">beforeCreate</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>$options<span class="token punctuation">.</span>router<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>_routerRoot <span class="token operator">=</span> <span class="token keyword">this</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>_router <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>$options<span class="token punctuation">.</span>router
        <span class="token keyword">this</span><span class="token punctuation">.</span>_router<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>
        Vue<span class="token punctuation">.</span>util<span class="token punctuation">.</span><span class="token function">defineReactive</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token string">'_route'</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_router<span class="token punctuation">.</span>history<span class="token punctuation">.</span>current<span class="token punctuation">)</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>_routerRoot <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>$parent <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>$parent<span class="token punctuation">.</span>_routerRoot<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token keyword">this</span>
      <span class="token punctuation">}</span>
      <span class="token function">registerInstance</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function">destroyed</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">registerInstance</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>

  Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span><span class="token class-name">Vue</span><span class="token punctuation">.</span>prototype<span class="token punctuation">,</span> <span class="token string">'$router'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token function">get</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_routerRoot<span class="token punctuation">.</span>_router <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>

  Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span><span class="token class-name">Vue</span><span class="token punctuation">.</span>prototype<span class="token punctuation">,</span> <span class="token string">'$route'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token function">get</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_routerRoot<span class="token punctuation">.</span>_route <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>

  Vue<span class="token punctuation">.</span><span class="token function">component</span><span class="token punctuation">(</span><span class="token string">'RouterView'</span><span class="token punctuation">,</span> View<span class="token punctuation">)</span>
  Vue<span class="token punctuation">.</span><span class="token function">component</span><span class="token punctuation">(</span><span class="token string">'RouterLink'</span><span class="token punctuation">,</span> Link<span class="token punctuation">)</span>

  <span class="token keyword">const</span> strats <span class="token operator">=</span> Vue<span class="token punctuation">.</span>config<span class="token punctuation">.</span>optionMergeStrategies
  <span class="token comment">// use the same hook merging strategy for route hooks</span>
  strats<span class="token punctuation">.</span>beforeRouteEnter <span class="token operator">=</span> strats<span class="token punctuation">.</span>beforeRouteLeave <span class="token operator">=</span> strats<span class="token punctuation">.</span>beforeRouteUpdate <span class="token operator">=</span> strats<span class="token punctuation">.</span>created
<span class="token punctuation">}</span>
</code></pre></div><h4 id="hash与hisotry">hash与hisotry</h4> <ul><li>hash模式url会出现</li> <li>history模式需要服务端的配合</li> <li>toB的系统推荐用hash，简单易用不需要server配合，对url不敏感</li> <li>toC的系统考虑h5 history,但需要服务端支持，history有利于seo，因为搜索引擎对于#后面的内容（锚）点一般是不收录的。</li></ul></div></article> <section class="post-meta main-div" data-v-12a4d4fc><section class="post-date clearfix" data-v-12a4d4fc><span class="create-date" data-v-12a4d4fc>
      发布于 : 2021-03-04
    </span> <span class="update-date" data-v-12a4d4fc>
      修改于 : 2021-12-02
    </span></section> <section class="post-links" data-v-12a4d4fc><a href="/posts/2021/03/09/webpack.html" class="post-link" data-v-12a4d4fc>
      下一篇 : webpack应用总结一
    </a> <a href="/posts/2021/03/02/vue-basics.html" class="post-link" data-v-12a4d4fc>
      上一篇 : vue基础知识
    </a></section></section> <div id="post-comments" class="main-div"><!----></div></div></main> <aside class="aside" data-v-0874e876><div class="info-card main-div" data-v-2bd66a30 data-v-0874e876><div class="info-card-header" data-v-2bd66a30><img src="https://www.mamingjuan.cn/assets/img/avatar.jpeg" alt="Glitr" class="info-avatar" data-v-2bd66a30></div> <div class="info-card-body" data-v-2bd66a30><section class="info-nickname" data-v-2bd66a30>
      Glitr
    </section> <section class="info-desc" data-v-2bd66a30>Enjoy coding,<br/>Enjoy life:)</section> <section class="info-contact" data-v-2bd66a30><section data-v-2bd66a30><span title="Beijing City, China" data-v-2bd66a30 data-v-2bd66a30><svg class="icon" style="font-size:1em;" data-v-2bd66a30 data-v-2bd66a30><title data-v-2bd66a30 data-v-2bd66a30>Beijing City, China</title><use xlink:href="#icon-location" data-v-2bd66a30 data-v-2bd66a30></use></svg><span class="info-text" data-v-2bd66a30 data-v-2bd66a30>
          Beijing City, China
        </span></span></section> <section data-v-2bd66a30><span title="Secrecy" data-v-2bd66a30 data-v-2bd66a30><svg class="icon" style="font-size:1em;" data-v-2bd66a30 data-v-2bd66a30><title data-v-2bd66a30 data-v-2bd66a30>Secrecy</title><use xlink:href="#icon-organization" data-v-2bd66a30 data-v-2bd66a30></use></svg><span class="info-text" data-v-2bd66a30 data-v-2bd66a30>
          Secrecy
        </span></span></section> <section data-v-2bd66a30><a href="mailto:glitteringma@gmail.com" title="glitteringma@gmail.com" data-v-2bd66a30 data-v-2bd66a30><svg class="icon" style="font-size:1em;" data-v-2bd66a30 data-v-2bd66a30><title data-v-2bd66a30 data-v-2bd66a30>glitteringma@gmail.com</title><use xlink:href="#icon-email" data-v-2bd66a30 data-v-2bd66a30></use></svg><span class="info-text" data-v-2bd66a30 data-v-2bd66a30>
          glitteringma@gmail.com
        </span></a></section></section></div> <div class="info-card-footer" data-v-2bd66a30><section class="info-sns clearfix" data-v-2bd66a30><a href="https://github.com/happy760690" target="_blank" class="sns-link" data-v-2bd66a30><span title="GitHub: glitzma" class="sns-icon" data-v-2bd66a30 data-v-2bd66a30><svg class="icon" style="font-size:1.5em;" data-v-2bd66a30 data-v-2bd66a30><title data-v-2bd66a30 data-v-2bd66a30>GitHub: glitzma</title><use xlink:href="#icon-github" data-v-2bd66a30 data-v-2bd66a30></use></svg></span></a><a href="https://twitter.com/x0BKGuGTNoqZ0F7" target="_blank" class="sns-link" data-v-2bd66a30><span title="Twitter: x0BKGuGTNoqZ0F7" class="sns-icon" data-v-2bd66a30 data-v-2bd66a30><svg class="icon" style="font-size:1.5em;" data-v-2bd66a30 data-v-2bd66a30><title data-v-2bd66a30 data-v-2bd66a30>Twitter: x0BKGuGTNoqZ0F7</title><use xlink:href="#icon-twitter" data-v-2bd66a30 data-v-2bd66a30></use></svg></span></a><a href="https://www.instagram.com/glitz9558/?hl=en" target="_blank" class="sns-link" data-v-2bd66a30><span title="Instagram: glitz9558" class="sns-icon" data-v-2bd66a30 data-v-2bd66a30><svg class="icon" style="font-size:1.5em;" data-v-2bd66a30 data-v-2bd66a30><title data-v-2bd66a30 data-v-2bd66a30>Instagram: glitz9558</title><use xlink:href="#icon-instagram" data-v-2bd66a30 data-v-2bd66a30></use></svg></span></a></section></div></div> <div class="post-nav-card main-div" style="position:relative;top:0;width:0px;" data-v-0874e876><div class="post-nav-contents"><svg class="icon"><title>book</title><use xlink:href="#icon-book"></use></svg> <span>文章目录</span> <div class="post-nav-toc"><ul><li><a href="/posts/2021/03/04/vue-principle.html#vue常见原理">vue常见原理</a><ul><li><a href="/posts/2021/03/04/vue-principle.html#模板编译过程概述">模板编译过程概述</a></li><li><a href="/posts/2021/03/04/vue-principle.html#响应式">响应式</a></li><li><a href="/posts/2021/03/04/vue-principle.html#vdom">vdom</a></li><li><a href="/posts/2021/03/04/vue-principle.html#diff算法概述">diff算法概述</a></li><li><a href="/posts/2021/03/04/vue-principle.html#组件的渲染更新过程">组件的渲染更新过程</a></li><li><a href="/posts/2021/03/04/vue-principle.html#将props传递子组件">将props传递子组件</a></li><li><a href="/posts/2021/03/04/vue-principle.html#hash模式">hash模式</a></li><li><a href="/posts/2021/03/04/vue-principle.html#hisotry模式">hisotry模式</a></li></ul></li></ul></div></div> <div class="post-nav-comments"><svg class="icon"><title>comment</title><use xlink:href="#icon-comment"></use></svg> <a href="/posts/2021/03/04/vue-principle.html#post-comments">
      评论
    </a></div></div></aside></div> <footer class="footer" data-v-e3c69672><p class="sns-links" data-v-e3c69672><a href="https://github.com/happy760690" target="_blank" class="sns-link" data-v-e3c69672><span title="GitHub: glitzma" class="sns-icon" data-v-e3c69672 data-v-e3c69672><svg class="icon" style="font-size:25px;" data-v-e3c69672 data-v-e3c69672><title data-v-e3c69672 data-v-e3c69672>GitHub: glitzma</title><use xlink:href="#icon-github" data-v-e3c69672 data-v-e3c69672></use></svg></span></a><a href="https://twitter.com/x0BKGuGTNoqZ0F7" target="_blank" class="sns-link" data-v-e3c69672><span title="Twitter: x0BKGuGTNoqZ0F7" class="sns-icon" data-v-e3c69672 data-v-e3c69672><svg class="icon" style="font-size:25px;" data-v-e3c69672 data-v-e3c69672><title data-v-e3c69672 data-v-e3c69672>Twitter: x0BKGuGTNoqZ0F7</title><use xlink:href="#icon-twitter" data-v-e3c69672 data-v-e3c69672></use></svg></span></a><a href="https://www.instagram.com/glitz9558/?hl=en" target="_blank" class="sns-link" data-v-e3c69672><span title="Instagram: glitz9558" class="sns-icon" data-v-e3c69672 data-v-e3c69672><svg class="icon" style="font-size:25px;" data-v-e3c69672 data-v-e3c69672><title data-v-e3c69672 data-v-e3c69672>Instagram: glitz9558</title><use xlink:href="#icon-instagram" data-v-e3c69672 data-v-e3c69672></use></svg></span></a></p> <div class="copyright" data-v-e3c69672>
    © 2014 –
    <span itemprop="copyrightYear" data-v-e3c69672>2021</span> <span class="post-meta-divider" data-v-e3c69672>|</span> <span itemprop="copyrightHolder" class="author" data-v-e3c69672>Glitr</span></div></footer></div><div class="global-ui"><!----><!----></div></div>
    <script src="/assets/js/app~d0ae3f07.7ae9fe33.js" defer></script><script src="/assets/js/9.d80ec364.js" defer></script><script src="/assets/js/43.c424591e.js" defer></script><script src="/assets/js/app~db300d2f.43f6a87c.js" defer></script>
  </body>
</html>
