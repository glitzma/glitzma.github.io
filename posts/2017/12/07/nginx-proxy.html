<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Nginx相关知识 | 马明娟</title>
    <meta name="generator" content="VuePress 1.8.2">
    
    <meta name="description" content="This is my blog">
    
    <link rel="preload" href="/assets/css/0.styles.60a8e50c.css" as="style"><link rel="preload" href="/assets/js/app~d0ae3f07.60a8e50c.js" as="script"><link rel="preload" href="/assets/css/styles.1dc2ca0e.css" as="style"><link rel="preload" href="/assets/js/app~db300d2f.1dc2ca0e.js" as="script"><link rel="preload" href="/assets/css/9.styles.1267247d.css" as="style"><link rel="preload" href="/assets/js/9.1267247d.js" as="script"><link rel="preload" href="/assets/js/53.76fe2763.js" as="script"><link rel="prefetch" href="/assets/css/10.styles.df6adbd6.css"><link rel="prefetch" href="/assets/css/2.styles.237d92a0.css"><link rel="prefetch" href="/assets/css/3.styles.a2ad42e7.css"><link rel="prefetch" href="/assets/css/4.styles.e7d6d1cd.css"><link rel="prefetch" href="/assets/css/5.styles.29b5611b.css"><link rel="prefetch" href="/assets/css/6.styles.352fac64.css"><link rel="prefetch" href="/assets/css/7.styles.867e09b5.css"><link rel="prefetch" href="/assets/css/8.styles.ae1b02b5.css"><link rel="prefetch" href="/assets/js/10.df6adbd6.js"><link rel="prefetch" href="/assets/js/100.8341604f.js"><link rel="prefetch" href="/assets/js/101.e4677556.js"><link rel="prefetch" href="/assets/js/102.58ee5dcf.js"><link rel="prefetch" href="/assets/js/103.f01b8b28.js"><link rel="prefetch" href="/assets/js/104.d98641e9.js"><link rel="prefetch" href="/assets/js/105.92e693d8.js"><link rel="prefetch" href="/assets/js/106.198e3839.js"><link rel="prefetch" href="/assets/js/107.9f23e3be.js"><link rel="prefetch" href="/assets/js/108.db7a51af.js"><link rel="prefetch" href="/assets/js/109.1bc30e68.js"><link rel="prefetch" href="/assets/js/11.14fc4ee5.js"><link rel="prefetch" href="/assets/js/110.7be48944.js"><link rel="prefetch" href="/assets/js/111.c1cba4fc.js"><link rel="prefetch" href="/assets/js/112.4aa747eb.js"><link rel="prefetch" href="/assets/js/113.3ff8e204.js"><link rel="prefetch" href="/assets/js/114.49d7733d.js"><link rel="prefetch" href="/assets/js/115.33c87998.js"><link rel="prefetch" href="/assets/js/116.ef55164c.js"><link rel="prefetch" href="/assets/js/117.07cbfdf4.js"><link rel="prefetch" href="/assets/js/118.d3b0e26a.js"><link rel="prefetch" href="/assets/js/119.3adada11.js"><link rel="prefetch" href="/assets/js/12.1f23d526.js"><link rel="prefetch" href="/assets/js/120.70f5d7b6.js"><link rel="prefetch" href="/assets/js/121.cb4636a3.js"><link rel="prefetch" href="/assets/js/122.44b32d4e.js"><link rel="prefetch" href="/assets/js/123.345e25d5.js"><link rel="prefetch" href="/assets/js/124.1f352b03.js"><link rel="prefetch" href="/assets/js/125.9f92124f.js"><link rel="prefetch" href="/assets/js/126.bddad644.js"><link rel="prefetch" href="/assets/js/127.431208d8.js"><link rel="prefetch" href="/assets/js/128.74f3002d.js"><link rel="prefetch" href="/assets/js/129.f65b2835.js"><link rel="prefetch" href="/assets/js/13.2fb58aa0.js"><link rel="prefetch" href="/assets/js/130.8a4804b3.js"><link rel="prefetch" href="/assets/js/131.a8e8dd81.js"><link rel="prefetch" href="/assets/js/14.a0c0f222.js"><link rel="prefetch" href="/assets/js/15.d901ab83.js"><link rel="prefetch" href="/assets/js/16.792ec35a.js"><link rel="prefetch" href="/assets/js/17.64bc1c5b.js"><link rel="prefetch" href="/assets/js/18.a9a90144.js"><link rel="prefetch" href="/assets/js/19.5b6a896e.js"><link rel="prefetch" href="/assets/js/2.237d92a0.js"><link rel="prefetch" href="/assets/js/20.35e9e5ed.js"><link rel="prefetch" href="/assets/js/21.b09a448c.js"><link rel="prefetch" href="/assets/js/22.76d13959.js"><link rel="prefetch" href="/assets/js/23.75442f4c.js"><link rel="prefetch" href="/assets/js/24.9d39ec84.js"><link rel="prefetch" href="/assets/js/25.9e833e02.js"><link rel="prefetch" href="/assets/js/26.648819aa.js"><link rel="prefetch" href="/assets/js/27.c98c3adb.js"><link rel="prefetch" href="/assets/js/28.09d3187c.js"><link rel="prefetch" href="/assets/js/29.79b73f97.js"><link rel="prefetch" href="/assets/js/3.a2ad42e7.js"><link rel="prefetch" href="/assets/js/30.9753a61b.js"><link rel="prefetch" href="/assets/js/31.98a13fd1.js"><link rel="prefetch" href="/assets/js/32.d9983a3f.js"><link rel="prefetch" href="/assets/js/33.6adada74.js"><link rel="prefetch" href="/assets/js/34.65625667.js"><link rel="prefetch" href="/assets/js/35.619f1ba3.js"><link rel="prefetch" href="/assets/js/36.2bfba54b.js"><link rel="prefetch" href="/assets/js/37.77c5843a.js"><link rel="prefetch" href="/assets/js/38.3501732b.js"><link rel="prefetch" href="/assets/js/39.deade9cb.js"><link rel="prefetch" href="/assets/js/4.e7d6d1cd.js"><link rel="prefetch" href="/assets/js/40.a7341eff.js"><link rel="prefetch" href="/assets/js/41.cdd29a29.js"><link rel="prefetch" href="/assets/js/42.b5e26dfa.js"><link rel="prefetch" href="/assets/js/43.a8a88297.js"><link rel="prefetch" href="/assets/js/44.3efcfb6a.js"><link rel="prefetch" href="/assets/js/45.5c953c18.js"><link rel="prefetch" href="/assets/js/46.77d2c955.js"><link rel="prefetch" href="/assets/js/47.8a9dec54.js"><link rel="prefetch" href="/assets/js/48.6a940896.js"><link rel="prefetch" href="/assets/js/49.f169bd8d.js"><link rel="prefetch" href="/assets/js/5.29b5611b.js"><link rel="prefetch" href="/assets/js/50.7aa85870.js"><link rel="prefetch" href="/assets/js/51.3cd5c00e.js"><link rel="prefetch" href="/assets/js/52.2b2f704a.js"><link rel="prefetch" href="/assets/js/54.1368570f.js"><link rel="prefetch" href="/assets/js/55.faa0a829.js"><link rel="prefetch" href="/assets/js/56.abdd6999.js"><link rel="prefetch" href="/assets/js/57.d2970556.js"><link rel="prefetch" href="/assets/js/58.6ebdf92b.js"><link rel="prefetch" href="/assets/js/59.0c200714.js"><link rel="prefetch" href="/assets/js/6.352fac64.js"><link rel="prefetch" href="/assets/js/60.ef0e8e33.js"><link rel="prefetch" href="/assets/js/61.c9efad1b.js"><link rel="prefetch" href="/assets/js/62.720ed424.js"><link rel="prefetch" href="/assets/js/63.38becca2.js"><link rel="prefetch" href="/assets/js/64.fa362f4e.js"><link rel="prefetch" href="/assets/js/65.b097b84f.js"><link rel="prefetch" href="/assets/js/66.da0cff60.js"><link rel="prefetch" href="/assets/js/67.f74edb5f.js"><link rel="prefetch" href="/assets/js/68.71acb12b.js"><link rel="prefetch" href="/assets/js/69.f93307c3.js"><link rel="prefetch" href="/assets/js/7.867e09b5.js"><link rel="prefetch" href="/assets/js/70.6d0e2807.js"><link rel="prefetch" href="/assets/js/71.32038ecc.js"><link rel="prefetch" href="/assets/js/72.feccb41d.js"><link rel="prefetch" href="/assets/js/73.d1264a5d.js"><link rel="prefetch" href="/assets/js/74.290acc66.js"><link rel="prefetch" href="/assets/js/75.fa66209e.js"><link rel="prefetch" href="/assets/js/76.f2494724.js"><link rel="prefetch" href="/assets/js/77.6f9e7fc7.js"><link rel="prefetch" href="/assets/js/78.28b84370.js"><link rel="prefetch" href="/assets/js/79.1ea3b2ab.js"><link rel="prefetch" href="/assets/js/8.ae1b02b5.js"><link rel="prefetch" href="/assets/js/80.9bc74cf1.js"><link rel="prefetch" href="/assets/js/81.c740b5e0.js"><link rel="prefetch" href="/assets/js/82.9187062a.js"><link rel="prefetch" href="/assets/js/83.54271c64.js"><link rel="prefetch" href="/assets/js/84.9b07cdd3.js"><link rel="prefetch" href="/assets/js/85.343e56ab.js"><link rel="prefetch" href="/assets/js/86.88320846.js"><link rel="prefetch" href="/assets/js/87.7c6e2f4b.js"><link rel="prefetch" href="/assets/js/88.9c8e9efa.js"><link rel="prefetch" href="/assets/js/89.b33fd5f6.js"><link rel="prefetch" href="/assets/js/90.56be089e.js"><link rel="prefetch" href="/assets/js/91.19284eca.js"><link rel="prefetch" href="/assets/js/92.4f7166df.js"><link rel="prefetch" href="/assets/js/93.37453b2e.js"><link rel="prefetch" href="/assets/js/94.bd9b6da0.js"><link rel="prefetch" href="/assets/js/95.198112a2.js"><link rel="prefetch" href="/assets/js/96.faa996de.js"><link rel="prefetch" href="/assets/js/97.c867d570.js"><link rel="prefetch" href="/assets/js/98.7253fd4a.js"><link rel="prefetch" href="/assets/js/99.3f4f2a43.js">
    <link rel="stylesheet" href="/assets/css/0.styles.60a8e50c.css"><link rel="stylesheet" href="/assets/css/styles.1dc2ca0e.css"><link rel="stylesheet" href="/assets/css/9.styles.1267247d.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div id="vuepress-theme-glitzma"><header class="header" style="background-size:cover;background-repeat:no-repeat;background-position:center;background-attachment:scroll;background-image:url(/assets/img/header-image-04.jpg);" data-v-e4a0ebe0><div data-v-6654f004 data-v-e4a0ebe0><nav class="navbar" data-v-6654f004><div class="container" data-v-6654f004><a href="/" class="router-link-active" data-v-6654f004><span class="navbar-site-name" data-v-6654f004>
          马明娟
        </span></a> <div class="navbar-toggler" data-v-6654f004><svg class="icon" style="font-size:1.2em;" data-v-6654f004 data-v-6654f004><title data-v-6654f004 data-v-6654f004>menu</title><use xlink:href="#icon-menu" data-v-6654f004 data-v-6654f004></use></svg></div> <div class="navbar-links" data-v-6654f004><a href="/" class="navbar-link" data-v-6654f004>
            欢迎页
          </a><a href="/posts/" class="navbar-link router-link-active" data-v-6654f004>
            帖子
          </a><a href="/custom-pages/" class="navbar-link" data-v-6654f004>
            关于
          </a></div></div></nav> <div class="navbar-holder" style="display:none;" data-v-6654f004></div></div> <div class="banner" data-v-e2d7da12 data-v-e4a0ebe0 data-v-e4a0ebe0><div class="container" data-v-e2d7da12><div class="center" data-v-e2d7da12></div></div></div></header> <div class="container clearfix show-aside" data-v-0874e876 data-v-0874e876><main class="main" data-v-0874e876><div class="post" data-v-0874e876 data-v-0874e876><section class="post-meta main-div" data-v-12a4d4fc><section class="post-date clearfix" data-v-12a4d4fc><span class="create-date" data-v-12a4d4fc>
      发布于 : 2017-12-07
    </span> <span class="update-date" data-v-12a4d4fc>
      修改于 : 2021-12-09
    </span></section> <section class="post-links" data-v-12a4d4fc><a href="/posts/2017/12/07/linux-environment.html" class="post-link" data-v-12a4d4fc>
      下一篇 : Linux methods to view and modify PATH environment variables
    </a> <a href="/posts/2017/12/06/different-extend.html" class="post-link" data-v-12a4d4fc>
      上一篇 : The difference between jquery.fn.extend and jquery.extend
    </a></section></section> <article class="main-div"><div class="post-content content__default"><h2 id="nginx相关知识">nginx相关知识</h2> <h3 id="系统">系统</h3> <p>CENTOS&gt;=7.0,位数 X64 CENTOS 7.2</p> <h4 id="nginx优势">nginx优势</h4> <ul><li><p>IO多路复用 多个描述符的IO操作都能在一个线程里并发交替顺序完成，复用线程.<br>
Nginx 在启动后，会有一个 master 进程和多个相互独立的 worker 进程。<br>
接收来自外界的信号,向各worker进程发送信号,每个进程都有可能来处理这个连接。<br>
master 进程能监控 worker 进程的运行状态，当 worker 进程退出后(异常情况下)，会自动启动新的 worker 进程。<br>
worker 进程数，一般会设置成机器 cpu 核数。因为更多的worker 数，只会导致进程相互竞争 cpu，从而带来不必要的上下文切换。<br>
使用多进程模式，不仅能提高并发率，而且进程之间相互独立，一个 worker 进程挂了不会影响到其他 worker 进程。</p></li> <li><p>CPU亲和 把CPU内核和nginx的工作进程绑定在一起，让每个worker进程固定在一个CPU上执行，从而减少CPU的切换并提高缓存命中率，提高 性能</p></li> <li><p>sendfile 零拷贝传输模式<br>
默认配置下，Nginx 读取本地文件后，在进行网络传输时会先将硬盘文件从硬盘中读取到 Nginx 的文件缓冲区中，操作流程为:硬盘 → 内核文件缓冲区 → 应用缓冲区。然后将 Nginx 文件缓冲区的数据写入网络接口，操作流程：应用缓冲区 → 内核网络缓冲区 → 网络接口。</p> <p>Nginx 的本地文件在进行网络传输的过程中，经历了上述读取与写入两个操作过程，两次操作都在内核缓冲区中存储了相同的数据。为了提高文件的传输效率，内核提供了零复制技术，该技术支持文件在内核缓冲区内直接交换打开的文件句柄，无须重复复制文件内容到缓冲区，则上述两个操作的流程变为：硬盘 → 内核文件缓冲区 → 内核网络缓冲区 → 网络接口。</p> <p>零复制技术减少了文件的读写次数，提升了本地文件的网络传输速度。内核缓冲区的默认大小为 4096B。</p></li></ul> <h4 id="nginx版本">nginx版本</h4> <ul><li>Mainline version 开发版</li> <li>Stable version 稳定版</li> <li>Legacy versions 历史版本</li></ul> <p><a href="http://nginx.org/en/download.html" target="_blank" rel="noopener noreferrer">nginx下载地址<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> <a href="http://nginx.org/en/linux_packages.html#stable" target="_blank" rel="noopener noreferrer">nginx linux package<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>CentOS下YUM安装<br>
路径：/etc/yum.repos.d/nginx.repo<br>
文件内容：</p> <div class="language- extra-class"><pre class="language-text"><code>[nginx]
name=nginx repo
baseurl=http://nginx.org/packages/centos/7/$basearch/
gpgcheck=0
enabled=1
</code></pre></div><p>命令：</p> <div class="language- extra-class"><pre class="language-text"><code>yum install nginx -y
nginx -v
nginx -V
</code></pre></div><h3 id="配置文件及用途">配置文件及用途</h3> <p>查看配置文件和目录</p> <div class="language- extra-class"><pre class="language-text"><code>rpm -ql nginx
</code></pre></div><p>配置文件及用途</p> <table><thead><tr><th>类型</th> <th>路径</th> <th>用途</th></tr></thead> <tbody><tr><td>配置文件</td> <td>/etc/logrotate.d/nginx</td> <td>用于logrotate服务的日志切割</td></tr> <tr><td>配置文件</td> <td>/etc/nginx /etc/nginx/nginx.conf /etc/nginx/conf.d /etc/nginx/conf.d/default.conf</td> <td>主配置文件</td></tr> <tr><td>配置文件</td> <td>/etc/nginx/fastcgi_params /etc/nginx/scgi_params /etc/nginx/uwsgi_params</td> <td>cgi配置,fastcgi配置</td></tr> <tr><td>配置文件</td> <td>/etc/nginx/koi-utf /etc/nginx/koi-win /etc/nginx/win-utf</td> <td>编码转换映射转化文件</td></tr> <tr><td>配置文件</td> <td>/etc/nginx/mime.types</td> <td>设置http协议的Content-Type与扩展名对应关系</td></tr> <tr><td>配置文件</td> <td>/usr/lib/systemd/system/nginx-debug.service /usr/lib/systemd/system/nginx.service /etc/sysconfig/nginx /etc/sysconfig/nginx-debug</td> <td>用于配置系统守护进程管理器管理方式</td></tr> <tr><td>配置文件</td> <td>/etc/nginx/modules /usr/lib64/nginx/modules</td> <td>nginx模块目录</td></tr> <tr><td>命令</td> <td>/usr/share/doc/nginx-1.14.0 /usr/share/doc/nginx-1.14.0/COPYRIGHT</td> <td>nginx的手册和帮助文件</td></tr> <tr><td>目录</td> <td>/var/cache/nginx</td> <td>nginx的缓存目录</td></tr> <tr><td>目录</td> <td>/var/log/nginx</td> <td>nginx的日志目录</td></tr></tbody></table> <p>安装目录和路径</p> <div class="language-shell extra-class"><pre class="language-shell"><code>--prefix<span class="token operator">=</span>/etc/nginx <span class="token comment"># 安装目录</span>
--sbin-path<span class="token operator">=</span>/usr/sbin/nginx <span class="token comment"># 可执行文件</span>
--modules-path<span class="token operator">=</span>/usr/lib64/nginx/modules <span class="token comment"># 安装模块</span>
--conf-path<span class="token operator">=</span>/etc/nginx/nginx.conf  <span class="token comment"># 配置文件路径</span>
--error-log-path<span class="token operator">=</span>/var/log/nginx/error.log  <span class="token comment"># 错误日志</span>
--http-log-path<span class="token operator">=</span>/var/log/nginx/access.log  <span class="token comment"># 访问日志</span>
--pid-path<span class="token operator">=</span>/var/run/nginx.pid <span class="token comment"># 进程ID</span>
--lock-path<span class="token operator">=</span>/var/run/nginx.lock <span class="token comment"># 加锁对象</span>
</code></pre></div><p>执行对应模块时，nginx所保留的临时性文件</p> <div class="language-shell extra-class"><pre class="language-shell"><code>--http-client-body-temp-path<span class="token operator">=</span>/var/cache/nginx/client_temp <span class="token comment"># 客户端请求体临时路径</span>
--http-proxy-temp-path<span class="token operator">=</span>/var/cache/nginx/proxy_temp <span class="token comment"># 代理临时路径</span>
--http-fastcgi-temp-path<span class="token operator">=</span>/var/cache/nginx/fastcgi_temp 
--http-uwsgi-temp-path<span class="token operator">=</span>/var/cache/nginx/uwsgi_temp 
--http-scgi-temp-path<span class="token operator">=</span>/var/cache/nginx/scgi_temp 
</code></pre></div><p>设置nginx进程启动的用户和用户组</p> <div class="language-shell extra-class"><pre class="language-shell"><code>--user<span class="token operator">=</span>nginx   <span class="token comment"># 指定用户</span>
--group<span class="token operator">=</span>nginx  <span class="token comment"># 指定用户组</span>
</code></pre></div><p>设置额外的参数将被添加到<code>CFLAGS</code>变量,<code>CFLAGS</code>变量用来存放C语言编译时的优化参数</p> <div class="language-shell extra-class"><pre class="language-shell"><code>--with-cc-opt<span class="token operator">=</span>'-O2 -g -pipe -Wall -Wp,-D_FORTIFY_SOURCE<span class="token operator">=</span><span class="token number">2</span> -fexceptions -fstack-protector-strong 
</code></pre></div><p>设置链接文件参数，链接系统库。<br>
定义要传递到C链接器命令行的其他选项。<br>
PCRE库，需要指定<code>–with-ld-opt=&quot;-L /usr/local/lib&quot;</code></p> <div class="language-shell extra-class"><pre class="language-shell"><code>--with-ld-opt<span class="token operator">=</span><span class="token string">'-Wl,-z,relro -Wl,-z,now -pie'</span>
</code></pre></div><p>其它参数</p> <div class="language- extra-class"><pre class="language-text"><code>--with-compat 
--with-file-aio 
--with-threads 
--with-http_addition_module 
--with-http_auth_request_module 
--with-http_dav_module 
--with-http_flv_module 
--with-http_gunzip_module 
--with-http_gzip_static_module 
--with-http_mp4_module 
--with-http_random_index_module 
--with-http_realip_module 
--with-http_secure_link_module 
--with-http_slice_module 
--with-http_ssl_module 
--with-http_stub_status_module 
--with-http_sub_module 
--with-http_v2_module 
--with-mail 
--with-mail_ssl_module 
--with-stream 
--with-stream_realip_module 
--with-stream_ssl_module 
--with-stream_ssl_preread_module 
--param=ssp-buffer-size=4 -grecord-gcc-switches -m64 -mtune=generic -fPIC' 
</code></pre></div><p>主要的配置文件</p> <div class="language-shell extra-class"><pre class="language-shell"><code>/etc/nginx/nginx.conf <span class="token comment"># 核心配置文件</span>
/etc/nginx/conf.d/*.conf <span class="token comment"># 包含conf.d目录下面的所有配置文件</span>
/etc/nginx/conf.d/default.conf <span class="token comment"># 默认http服务器配置文件</span>
</code></pre></div><h4 id="cgi配置文件">cgi配置文件</h4> <ul><li>CGI是common gateway interface(通用网关接口)</li> <li>Web Server 通过cgi协议可以把动态的请求传递给如php、jsp、python和perl等应用程序</li> <li>FastCGI 实际上是增加了一些扩展功能的 CGI ,是 CGI 的改进，描述了客户端和Web服务器程序之间传输数据的一种标准。</li> <li>SCGI协议是一个CGI（通用网关接口）协议的替代品· 它是一个应用与HTTP服务器的接口标准，类似于FastCGI,但是它设计得更为容易实现</li> <li>uwsgi是一个Web服务器，它实现了WSGI协议、uwsgi、http等协议</li></ul> <table><thead><tr><th>路径</th> <th>用途</th></tr></thead> <tbody><tr><td>/etc/nginx/fastcgi_params</td> <td>fastcgi配置</td></tr> <tr><td>/etc/nginx/scgi_params</td> <td>scgi配置</td></tr> <tr><td>/etc/nginx/uwsgi_params</td> <td>uwsgi配置</td></tr></tbody></table> <h4 id="编码转换映射转化文件">编码转换映射转化文件</h4> <ul><li>这三个文件都是与编码转换映射文件，用于在输出内容到客户端时，将一种编码转换到另一种编码</li> <li>koi8-r是斯拉夫文字8位元编码，供俄语及保加利亚语使用。在Unicode未流行之前，KOI8-R 是最为广泛使用的俄语编码，使用率甚至起ISO/IEC 8859-5还高。这3个文件存在是因为作者是俄国人的原因。</li></ul> <table><thead><tr><th>路径</th> <th>用途</th></tr></thead> <tbody><tr><td>/etc/nginx/koi-utf</td> <td>koi8-r &lt;--&gt; utf-8</td></tr> <tr><td>/etc/nginx/koi-win</td> <td>koi8-r &lt;--&gt; windows-1251</td></tr> <tr><td>/etc/nginx/win-utf</td> <td>windows-1251 &lt; -- &gt; utf-8</td></tr></tbody></table> <h4 id="扩展名文件">扩展名文件</h4> <p><code>/etc/nginx/mime.types</code> 设置http协议的Content-Type与扩展名对应关系</p> <h4 id="守护进程管理">守护进程管理</h4> <p>用于配置系统守护进程管理器管理方式</p> <table><thead><tr><th>路径</th></tr></thead> <tbody><tr><td>/usr/lib/systemd/system/nginx-debug.service</td></tr> <tr><td>/usr/lib/systemd/system/nginx.service</td></tr> <tr><td>/etc/sysconfig/nginx</td></tr> <tr><td>/etc/sysconfig/nginx-debug</td></tr></tbody></table> <div class="language-shell extra-class"><pre class="language-shell"><code>systemctl restart nginx.service
</code></pre></div><h4 id="nginx模块目录">nginx模块目录</h4> <p><code>/etc/nginx/modules</code>最基本的共享库和内核模块。<br>
目的是存放用于启动系统和执行root文件系统的命令的如<code>/bin</code>和<code>/sbin</code>的二进制文件的共享库，或者存放32位，或者64位(file命令查看)
<code>/usr/lib64/nginx/modules</code> 64位共享库</p> <h4 id="nginx的手册和帮助文件">nginx的手册和帮助文件</h4> <table><thead><tr><th>路径</th> <th>用途</th></tr></thead> <tbody><tr><td>/usr/share/doc/nginx-1.14.2</td> <td>帮助文档</td></tr> <tr><td>/usr/share/doc/nginx-1.14.0/COPYRIGHT</td> <td>版权声明</td></tr> <tr><td>/usr/share/man/man8/nginx.8.gz</td> <td>手册</td></tr></tbody></table> <h4 id="nginx服务的启动管理的可执行文件">nginx服务的启动管理的可执行文件</h4> <table><thead><tr><th>路径</th> <th>用途</th></tr></thead> <tbody><tr><td>/usr/sbin/nginx</td> <td>可执行命令</td></tr> <tr><td>/usr/sbin/nginx-debug</td> <td>调试执行可执行命令</td></tr></tbody></table> <h3 id="nginx内容配置">nginx内容配置</h3> <h4 id="nginx配置语法">nginx配置语法</h4> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment"># 使用#可以添加注释,使用$符号可以使用变量</span>
<span class="token comment"># 配置文件由指令与指令块组成,指令块以{}将多条指令组织在一起</span>
http <span class="token punctuation">{</span>
<span class="token comment"># include语句允许把多个配置文件组合起来以提升可维护性    </span>
    include       mime.types<span class="token punctuation">;</span>
<span class="token comment"># 每条指令以;(分号)结尾，指令与参数之间以空格分隔</span>
    default_type  application/octet-stream<span class="token punctuation">;</span>
    sendfile        on<span class="token punctuation">;</span>
    keepalive_timeout  <span class="token number">65</span><span class="token punctuation">;</span>
    server <span class="token punctuation">{</span>
        listen       <span class="token number">80</span><span class="token punctuation">;</span>
        server_name  localhost<span class="token punctuation">;</span>
<span class="token comment"># 有些指令可以支持正则表达式        </span>
        location / <span class="token punctuation">{</span>
            root   html<span class="token punctuation">;</span>
            index  index.html index.htm<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        error_page   <span class="token number">500</span> <span class="token number">502</span> <span class="token number">503</span> <span class="token number">504</span>  /50x.html<span class="token punctuation">;</span>
        location <span class="token operator">=</span> /50x.html <span class="token punctuation">{</span>
            root   html<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="全局和服务配置">全局和服务配置</h4> <table><thead><tr><th>分类</th> <th>配置项</th> <th>作用</th></tr></thead> <tbody><tr><td>全局</td> <td>user</td> <td>设置nginx服务的系统使用用户</td></tr> <tr><td>全局</td> <td>worker_processes</td> <td>工作进程数,一般和CPU数量相同</td></tr> <tr><td>全局</td> <td>error_log</td> <td>nginx的错误日志</td></tr> <tr><td>全局</td> <td>pid</td> <td>nginx服务启动时的pid</td></tr></tbody></table> <h4 id="事件配置">事件配置</h4> <table><thead><tr><th>分类</th> <th>配置项</th> <th>作用</th></tr></thead> <tbody><tr><td>events</td> <td>worker_connections</td> <td>每个进程允许的最大连接数 10000</td></tr> <tr><td>events</td> <td>use</td> <td>指定使用哪种模型（select/poll/epoll）,建议让nginx自动选择,linux内核2.6以上一般能使用epoll，提高性能。</td></tr></tbody></table> <h4 id="http配置">http配置</h4> <p>配置的文件<code>/etc/nginx/nginx.conf</code>，一个HTTP下面可以配置多个server。</p> <div class="language-shell extra-class"><pre class="language-shell"><code>user  nginx<span class="token punctuation">;</span>   <span class="token comment"># 设置nginx服务的系统使用用户  </span>
worker_processes  <span class="token number">1</span><span class="token punctuation">;</span>  <span class="token comment"># 工作进程数,一般和CPU数量相同 </span>

error_log  /var/log/nginx/error.log warn<span class="token punctuation">;</span>   <span class="token comment"># nginx的错误日志  </span>
pid        /var/run/nginx.pid<span class="token punctuation">;</span>   <span class="token comment"># nginx服务启动时的pid</span>

events <span class="token punctuation">{</span>
    worker_connections  <span class="token number">1024</span><span class="token punctuation">;</span> <span class="token comment"># 每个进程允许的最大连接数 10000</span>
<span class="token punctuation">}</span>

http <span class="token punctuation">{</span>
    include       /etc/nginx/mime.types<span class="token punctuation">;</span> <span class="token comment"># 文件后缀和类型类型的对应关系</span>
    default_type  application/octet-stream<span class="token punctuation">;</span> <span class="token comment"># 默认content-type</span>

    log_format  main  <span class="token string">'$remote_addr - $remote_user [$time_local] &quot;$request&quot; '</span>
                      <span class="token string">'$status $body_bytes_sent &quot;$http_referer&quot; '</span>
                      <span class="token string">'&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;'</span><span class="token punctuation">;</span>  <span class="token comment"># 日志记录格式</span>

    access_log  /var/log/nginx/access.log  main<span class="token punctuation">;</span> <span class="token comment"># 默认访问日志</span>

    sendfile        on<span class="token punctuation">;</span> <span class="token comment"># 启用sendfile</span>
    <span class="token comment">#tcp_nopush     on; # 懒发送</span>

    keepalive_timeout  <span class="token number">65</span><span class="token punctuation">;</span> <span class="token comment"># 超时时间是65秒</span>

    <span class="token comment">#gzip  on;gzip压缩</span>

    include /etc/nginx/conf.d/*.conf<span class="token punctuation">;</span> <span class="token comment"># 包含的子配置文件</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="server配置">server配置</h4> <p>文件为<code>/etc/nginx/conf.d/default.conf</code>,一个server下面可以配置多个location。</p> <div class="language-shell extra-class"><pre class="language-shell"><code>server <span class="token punctuation">{</span>
    listen       <span class="token number">80</span><span class="token punctuation">;</span>  <span class="token comment"># 监听的端口号</span>
    server_name  localhost<span class="token punctuation">;</span>  <span class="token comment"># 用域名方式访问的地址</span>

    <span class="token comment">#charset koi8-r; # 编码</span>
    <span class="token comment">#access_log  /var/log/nginx/host.access.log  main;  # 访问日志文件和名称</span>

    location / <span class="token punctuation">{</span>
        root   /usr/share/nginx/html<span class="token punctuation">;</span>  <span class="token comment"># 静态文件根目录</span>
        index  index.html index.htm<span class="token punctuation">;</span>  <span class="token comment"># 首页的索引文件</span>
    <span class="token punctuation">}</span>

    <span class="token comment">#error_page  404              /404.html;  # 指定错误页面</span>

    <span class="token comment"># redirect server error pages to the static page /50x.html</span>
    <span class="token comment"># 把后台错误重定向到静态的50x.html页面</span>
    error_page   <span class="token number">500</span> <span class="token number">502</span> <span class="token number">503</span> <span class="token number">504</span>  /50x.html<span class="token punctuation">;</span> 
    location <span class="token operator">=</span> /50x.html <span class="token punctuation">{</span>
        root   /usr/share/nginx/html<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment"># proxy the PHP scripts to Apache listening on 127.0.0.1:80</span>
    <span class="token comment"># 代理PHP脚本到80端口上的apache服务器</span>
    <span class="token comment">#location ~ \.php$ {</span>
    <span class="token comment">#    proxy_pass   http://127.0.0.1;</span>
    <span class="token comment">#}</span>

    <span class="token comment"># pass the PHP scripts to FastCGI server listening on 127.0.0.1:9000</span>
    <span class="token comment"># 把PHP脚本9000端口上监听的FastCGI服务</span>
    <span class="token comment">#location ~ \.php$ {</span>
    <span class="token comment">#    root           html;</span>
    <span class="token comment">#    fastcgi_pass   127.0.0.1:9000;</span>
    <span class="token comment">#    fastcgi_index  index.php;</span>
    <span class="token comment">#    fastcgi_param  SCRIPT_FILENAME  /scripts$fastcgi_script_name;</span>
    <span class="token comment">#    include        fastcgi_params;</span>
    <span class="token comment">#}</span>

    <span class="token comment"># deny access to .htaccess files, if Apache's document root</span>
    <span class="token comment"># concurs with nginx's one</span>
    <span class="token comment"># 不允许访问.htaccess文件</span>
    <span class="token comment"># location ~ /\.ht {</span>
    <span class="token comment">#     deny  all;</span>
    <span class="token comment"># }</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="systemd配置">Systemd配置</h4> <p>系统启动和服务器守护进程管理器，负责在系统启动或运行时，激活系统资源，服务器进程和其他进程，根据管理，字母d是守护进程（daemon）的缩写。</p> <h5 id="配置目录">配置目录</h5> <table><thead><tr><th>配置目录</th> <th>用途</th></tr></thead> <tbody><tr><td>/usr/lib/systemd/system</td> <td>每个服务最主要的启动脚本设置，类似于之前的/etc/initd.d</td></tr> <tr><td>/run/system/system</td> <td>系统执行过程中所产生的服务脚本，比上面的目录优先运行</td></tr> <tr><td>/etc/system/system</td> <td>管理员建立的执行脚本，类似于/etc/rc.d/rcN.d/Sxx类的功能，比上面目录优先运行，在三者之中，此目录优先级最高</td></tr></tbody></table> <h5 id="systemctl">systemctl</h5> <p><a href="https://www.cnblogs.com/zhuxiangru/p/9414038.html" target="_blank" rel="noopener noreferrer">配置nginx的systemctl命令<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <ul><li>监视和控制systemd的主要命令是systemctl</li> <li>该命令可用于查看系统状态和管理系统及服务</li></ul> <div class="language-shell extra-class"><pre class="language-shell"><code>命令：systemctl  <span class="token builtin class-name">command</span> name.service
启动：service name start –<span class="token operator">&gt;</span> systemctl start name.service
停止：service name stop –<span class="token operator">&gt;</span> systemctl stop name.service
重启：service name restart –<span class="token operator">&gt;</span> systemctl restart name.service
状态：service name status –<span class="token operator">&gt;</span> systemctl status name.service
</code></pre></div><h4 id="启动和重新加载">启动和重新加载</h4> <div class="language-shell extra-class"><pre class="language-shell"><code>systemctl restart nginx.service
systemctl reload nginx.service
nginx -s reload
</code></pre></div><h4 id="日志相关">日志相关</h4> <p>/var/log/nginx/access.log 访问日志
/var/log/nginx/error.log 错误日志</p> <ul><li>log_format</li></ul> <table><thead><tr><th>类型</th> <th>用法</th></tr></thead> <tbody><tr><td>语法</td> <td>log_format name [escape=default[json] string]</td></tr> <tr><td>默认</td> <td>log_format combined ...</td></tr> <tr><td>Context</td> <td>http</td></tr></tbody></table> <p><a href="http://nginx.org/en/docs/http/ngx_http_log_module.html#log_format" target="_blank" rel="noopener noreferrer">log_format例子<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a><br> <a href="http://nginx.org/en/docs/http/ngx_http_log_module.html" target="_blank" rel="noopener noreferrer">ngx_http_log_module<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>
内置变量</p> <table><thead><tr><th>名称</th> <th>含义</th></tr></thead> <tbody><tr><td>$remote_addr</td> <td>客户端地址</td></tr> <tr><td>$remote_user</td> <td>客户端用户名称</td></tr> <tr><td>$time_local</td> <td>访问时间和时区</td></tr> <tr><td>$request</td> <td>请求行</td></tr> <tr><td>$status</td> <td>HTTP请求状态</td></tr> <tr><td>$body_bytes_sent	发送给客户端文件内容大小</td> <td></td></tr></tbody></table> <ul><li>HTTP请求变量</li></ul> <p>注意要把-转成下划线,比如User-Agent对应于$http_user_agent</p> <table><thead><tr><th>名称</th> <th>含义</th> <th>例子</th></tr></thead> <tbody><tr><td>arg_PARAMETER</td> <td>请求参数</td> <td>$arg_name</td></tr> <tr><td>http_HEADER</td> <td>请求头</td> <td>$http_referer $http_host $http_user_agent $http_x_forwarded_for(代理过程)</td></tr> <tr><td>sent_http_HEADER</td> <td>响应头</td> <td>sent_http_cookie</td></tr></tbody></table> <p>IP1-&gt;IP2(代理)-&gt;IP3 会记录IP地址的代理过程</p> <p>http_x_forwarded_for=Client IP,Proxy(1) IP,Proxy(2) IP</p> <p>定义日志格式</p> <div class="language-shell extra-class"><pre class="language-shell"><code> <span class="token comment"># 定义一种日志格式 </span>
 log_format  main  <span class="token string">'$remote_addr - $remote_user [$time_local] &quot;$request&quot; '</span>
                      <span class="token string">'$status $body_bytes_sent &quot;$http_referer&quot; '</span>
                      <span class="token string">'&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;'</span><span class="token punctuation">;</span>

 log_format  zfpx  <span class="token string">'$arg_name $http_referer sent_http_date&quot;'</span><span class="token punctuation">;</span>
 <span class="token comment"># 指定写入的文件名和日志格式</span>
 access_log  /var/log/nginx/access.log  main<span class="token punctuation">;</span>    
</code></pre></div><p>查看日志</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token function">tail</span> -f /var/log/nginx/access.log

<span class="token number">221.216</span>.143.110 - - <span class="token punctuation">[</span>09/Jun/2018:22:41:18 +0800<span class="token punctuation">]</span> <span class="token string">&quot;GET / HTTP/1.1&quot;</span> <span class="token number">200</span> <span class="token number">612</span> <span class="token string">&quot;-&quot;</span> <span class="token string">&quot;Mozilla/5.0 (Windows NT 6.1; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/62.0.3202.94 Safari/537.36&quot;</span> <span class="token string">&quot;-&quot;</span>
</code></pre></div><h3 id="核心模块">核心模块</h3> <ul><li>监控ngin客户端的状态
模块名：<code>--with-http_stub_status_module</code></li></ul> <div class="language- extra-class"><pre class="language-text"><code>Syntax: stub_status on/off;
Default: -
Context: server-&gt;location
</code></pre></div><p>实战<br>
文件：<code>/etc/nginx/conf.d/default.conf</code></p> <div class="language-shell extra-class"><pre class="language-shell"><code>server <span class="token punctuation">{</span>
+    location /status<span class="token punctuation">{</span>
+       stub_status  on<span class="token punctuation">;</span>
+    <span class="token punctuation">}</span>
</code></pre></div><div class="language-shell extra-class"><pre class="language-shell"><code>systemctl reload nginx.service

http://192.171.207.104/status

Active connections: <span class="token number">2</span>            
server accepts handled requests  
 <span class="token number">3</span> <span class="token number">3</span> <span class="token number">10</span> 
Reading: <span class="token number">0</span> Writing: <span class="token number">1</span> Waiting: <span class="token number">1</span> 
</code></pre></div><table><thead><tr><th>参数</th> <th>含义</th></tr></thead> <tbody><tr><td>Active</td> <td>connections</td></tr> <tr><td>accepts</td> <td>总共处理的连接数</td></tr> <tr><td>handled</td> <td>成功创建握手数</td></tr> <tr><td>requests</td> <td>总共处理请求数</td></tr> <tr><td>Reading</td> <td>读取到客户端的Header信息数</td></tr> <tr><td>Writing</td> <td>返回给客户端的Header信息数</td></tr> <tr><td>Waiting</td> <td>开启keep-alive的情况下,这个值等于 active – (reading + writing)</td></tr></tbody></table> <ul><li>在根目录里随机选择一个主页显示</li></ul> <p>模块名：<code>--with-http_random_index_module</code></p> <div class="language-shell extra-class"><pre class="language-shell"><code>Syntax: random_index on/off<span class="token punctuation">;</span>
Default: off
Context: location
</code></pre></div><p>实战<br> <code>/etc/nginx/conf.d/default.conf</code></p> <div class="language- extra-class"><pre class="language-text"><code>+    location / {
+       root /opt/app;
+       random_index on;
+    }
</code></pre></div><ul><li>内容替换<br>
模块名：--with-http_sub_module</li></ul> <div class="language- extra-class"><pre class="language-text"><code>文本替换
Syntax: sub_filter string replacement;
Default: --
Context: http,service,location

只匹配一次
Syntax: sub_filter_once on|off;
Default: off
Context: http,service,location
</code></pre></div><p>实战<br>
文件位置：/etc/nginx/conf.d/default.conf</p> <div class="language-shell extra-class"><pre class="language-shell"><code>location / <span class="token punctuation">{</span>
        root   /usr/share/nginx/html<span class="token punctuation">;</span>
        index  index.html index.htm<span class="token punctuation">;</span>
+        sub_filter <span class="token string">'world'</span> <span class="token string">'mamingjuan'</span><span class="token punctuation">;</span>
+        sub_filter_once off<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre></div><ul><li>请求限制<br>
模块名<br>
--with-limit_conn_module 连接频率限制<br>
--with-limit_req_module 请求频率限制<br>
一次TCP请求至少产生一个HTTP请求<br>
SYN &gt; SYN,ACK-&gt;ACK-&gt;REQUEST-&gt;RESPONSE-&gt;FIN-&gt;ACK-&gt;FIN-&gt;ACK</li></ul> <p>ab</p> <p>Apache的ab命令模拟多线程并发请求，测试服务器负载压力，也可以测试nginx、lighthttp、IIS等其它Web服务器的压力。
其中-n 总共的请求数、-c 并发的请求数。</p> <div class="language-shell extra-class"><pre class="language-shell"><code>ab -n <span class="token number">40</span> -c <span class="token number">20</span> http://127.0.0.1/
</code></pre></div><p>请求限制<br>
模块：limit_req_zone</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment"># 可以以IP为key zone为空间的名称 size为申请空间的大小</span>
Syntax: limit_req_zone key <span class="token assign-left variable">zone</span><span class="token operator">=</span>name:size <span class="token assign-left variable">rate</span><span class="token operator">=</span>rate<span class="token punctuation">;</span>   
Default: --
Context: http<span class="token punctuation">(</span>定义在server以外<span class="token punctuation">)</span>
</code></pre></div><p>模块：limit_req</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment"># zone名称 number限制的数量</span>
Syntax: limit_req  <span class="token assign-left variable">zone</span><span class="token operator">=</span>name <span class="token punctuation">[</span>burst<span class="token operator">=</span>number<span class="token punctuation">]</span> <span class="token punctuation">[</span>nodelay<span class="token punctuation">]</span><span class="token punctuation">;</span>
Default: --
Context: http,server,location
</code></pre></div><p>案例</p> <div class="language-shell extra-class"><pre class="language-shell"><code>limit_req_zone <span class="token variable">$binary_remote_addr</span> <span class="token assign-left variable">zone</span><span class="token operator">=</span>req_zone:1m <span class="token assign-left variable">rate</span><span class="token operator">=</span>1r/s<span class="token punctuation">;</span>
server <span class="token punctuation">{</span>
  location /<span class="token punctuation">{</span>
      limit_req req_zone<span class="token punctuation">;</span>
      <span class="token comment"># 缓存区队列burst=3个,不延期，即每秒最多可处理rate+burst个.同时处理rate个</span>
      limit_req <span class="token assign-left variable">zone</span><span class="token operator">=</span>req_zone <span class="token assign-left variable">burst</span><span class="token operator">=</span><span class="token number">3</span> nodelay<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>$binary_remote_addr 表示远程的IP地址<br>
zone=req_zone:10m 表示一个内存区域大小为10m,并且设定了名称为req_zone<br>
rate=1r/s 表示请求的速率是1秒1个请求</p> <p>zone=req_zone 表示这个参数对应的全局设置就是req_zone的那个内存区域</p> <p>burst=3 表示请求队列的长度<br>
nodelay 表示不延时</p> <p>连接限制</p> <p>模块：limit_conn_zone</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment"># 可以以IP为key zone为空间的名称 size为申请空间的大小</span>
Syntax: limit_conn_zone key <span class="token assign-left variable">zone</span><span class="token operator">=</span>name:size<span class="token punctuation">;</span>   
Default: --
Context: http<span class="token punctuation">(</span>定义在server以外<span class="token punctuation">)</span>
</code></pre></div><p>模块：limit_conn</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment"># zone名称 number限制的数量</span>
Syntax: limit_conn  zone number<span class="token punctuation">;</span>
Default: --
Context: http,server,location
</code></pre></div><p>案例</p> <div class="language-shell extra-class"><pre class="language-shell"><code>limit_conn_zone <span class="token variable">$binanry_remote_addr</span> <span class="token assign-left variable">zone</span><span class="token operator">=</span>conn_zone:1m<span class="token punctuation">;</span>
server <span class="token punctuation">{</span>
  location /<span class="token punctuation">{</span>
      limit_conn conn_zone <span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>表明以ip为key，来限制每个ip访问文件时候，最多只能有一个在线，否则其余的都要返回不可用</p> <ul><li>访问控制<br>
基于IP的访问控制 -http_access_module<br>
基于用户的信任登录 -http_auth_basic_module</li></ul> <p>模块：http_access_module</p> <div class="language-shell extra-class"><pre class="language-shell"><code>Syntax: allow address<span class="token operator">|</span>all<span class="token punctuation">;</span>
Default: --
Context: http,server,location,limit_except


Syntax: deny address<span class="token operator">|</span>CIDR<span class="token operator">|</span>all<span class="token punctuation">;</span>
Default: --
Context: http,server,location,limit_except
</code></pre></div><div class="language-shell extra-class"><pre class="language-shell"><code>server <span class="token punctuation">{</span>
+ location ~ ^/admin.html<span class="token punctuation">{</span>
+      deny <span class="token number">192.171</span>.207.100<span class="token punctuation">;</span>
+      allow all<span class="token punctuation">;</span>
+    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>    

server <span class="token punctuation">{</span>
+ location ~ ^/admin.html<span class="token punctuation">{</span>
+    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$http_x_forwarded_for</span> <span class="token operator">!</span>~* <span class="token string">&quot;^8\.8\.8\.8&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
+       <span class="token builtin class-name">return</span> <span class="token number">403</span><span class="token punctuation">;</span>
+    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>  
</code></pre></div><table><thead><tr><th>符号</th> <th>含义</th></tr></thead> <tbody><tr><td>=</td> <td>严格匹配。如果这个查询匹配，那么将停止搜索并立即处理此请求。</td></tr> <tr><td>~</td> <td>为区分大小写匹配(可用正则表达式)</td></tr> <tr><td>!~</td> <td>为区分大小写不匹配</td></tr> <tr><td>~*</td> <td>为不区分大小写匹配(可用正则表达式)</td></tr> <tr><td>!~*</td> <td>为不区分大小写不匹配</td></tr> <tr><td>^~</td> <td>如果把这个前缀用于一个常规字符串,那么告诉nginx 如果路径匹配那么不测试正则表达式。</td></tr></tbody></table> <p>模块：http_auth_basic_module</p> <div class="language-shell extra-class"><pre class="language-shell"><code>Syntax: auth_basic string<span class="token operator">|</span>off<span class="token punctuation">;</span>
Default: auth_basic off<span class="token punctuation">;</span>
Context: http,server,location,limit_except

Syntax: auth_basic_user_file <span class="token function">file</span><span class="token punctuation">;</span>
Default: -<span class="token punctuation">;</span>
Context: http,server,location,limit_except
</code></pre></div><div class="language-shell extra-class"><pre class="language-shell"><code>htpasswd -c /etc/nginx/users.conf zhangsan
</code></pre></div><div class="language- extra-class"><pre class="language-text"><code>server {
+    auth_basic '请登录';
+    auth_basic_user_file /etc/nginx/users.conf;
</code></pre></div><h3 id="静态资源web服务">静态资源Web服务</h3> <p>静态资源：一般客户端发送请求到web服务器，web服务器从内存在取到相应的文件，返回给客户端，客户端解析并渲染显示出来。<br>
动态资源：一般客户端请求的动态资源，先将请求交于web容器，web容器连接数据库，数据库处理数据之后，将内容交给web服务器，web服务器返回给客户端解析渲染处理。</p> <table><thead><tr><th>类型</th> <th>种类</th></tr></thead> <tbody><tr><td>浏览器渲染</td> <td>HTML、CSS、JS</td></tr> <tr><td>图片</td> <td>JPEG、GIF、PNG</td></tr> <tr><td>视频</td> <td>FLV、MPEG</td></tr> <tr><td>下载文件</td> <td>Word、Excel</td></tr></tbody></table> <h4 id="cdn">CDN</h4> <p>CDN的全称是Content Delivery Network，即内容分发网络。<br>
CDN系统能够实时地根据网络流量和各节点的连接、负载状况以及到用户的距离和响应时间等综合信息将用户的请求重新导向离用户最近的服务节点上。其目的是使用户可就近取得所需内容，解决 Internet网络拥挤的状况，提高用户访问网站的响应速度。</p> <h4 id="配置语法">配置语法</h4> <p>sendfile不经过用户内核发送文件</p> <table><thead><tr><th>类型</th> <th>种类</th></tr></thead> <tbody><tr><td>语法</td> <td>sendfile on / off</td></tr> <tr><td>默认</td> <td>sendfile off;</td></tr> <tr><td>上下文</td> <td>http,server,location,if in location</td></tr></tbody></table> <p>tcp_nopush 在sendfile开启的情况下，提高网络包的传输效率</p> <table><thead><tr><th>类型</th> <th>种类</th></tr></thead> <tbody><tr><td>语法</td> <td>tcp_nopush on / off</td></tr> <tr><td>默认</td> <td>tcp_nopush off;</td></tr> <tr><td>上下文</td> <td>http,server,location</td></tr></tbody></table> <p>tcp_nodelay 在keepalive连接下，提高网络包的传输实时性</p> <table><thead><tr><th>类型</th> <th>种类</th></tr></thead> <tbody><tr><td>语法</td> <td>tcp_nodelay on / off</td></tr> <tr><td>默认</td> <td>tcp_nodelay on;</td></tr> <tr><td>上下文</td> <td>http,server,location</td></tr></tbody></table> <p>gzip 压缩文件可以节约带宽和提高网络传输效率</p> <table><thead><tr><th>类型</th> <th>种类</th></tr></thead> <tbody><tr><td>语法</td> <td>gzip on / off</td></tr> <tr><td>默认</td> <td>gzip off;</td></tr> <tr><td>上下文</td> <td>http,server,location</td></tr></tbody></table> <p>gzip_comp_level 压缩比率越高，文件被压缩的体积越小</p> <table><thead><tr><th>类型</th> <th>种类</th></tr></thead> <tbody><tr><td>语法</td> <td>gzip_comp_level level</td></tr> <tr><td>默认</td> <td>gzip_comp_level 1;</td></tr> <tr><td>上下文</td> <td>http,server,location</td></tr></tbody></table> <p>gzip_http_version 压缩HTTP版本</p> <table><thead><tr><th>类型</th> <th>种类</th></tr></thead> <tbody><tr><td>语法</td> <td>gzip_http_version 1.0/1.1</td></tr> <tr><td>默认</td> <td>gzip_http_version 1.1;</td></tr> <tr><td>上下文</td> <td>http,server,location</td></tr></tbody></table> <p>http_gzip-static_module 先找磁盘上找同名的.gz这个文件是否存在,节约CPU的压缩时间和性能损耗</p> <table><thead><tr><th>类型</th> <th>种类</th></tr></thead> <tbody><tr><td>语法</td> <td>gzip_static on/off</td></tr> <tr><td>默认</td> <td>gzip_static off;</td></tr> <tr><td>上下文</td> <td>http,server,location</td></tr></tbody></table> <div class="language-shell extra-class"><pre class="language-shell"><code>    location ~ .*<span class="token punctuation">\</span>.<span class="token punctuation">(</span>jpg<span class="token operator">|</span>png<span class="token operator">|</span>gif<span class="token punctuation">)</span>$ <span class="token punctuation">{</span>
        <span class="token function">gzip</span> off<span class="token punctuation">;</span><span class="token comment"># 关闭压缩</span>
        root /data/www/images<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    location ~ .*<span class="token punctuation">\</span>.<span class="token punctuation">(</span>html<span class="token operator">|</span>js<span class="token operator">|</span>css<span class="token punctuation">)</span>$ <span class="token punctuation">{</span>
        <span class="token function">gzip</span> on<span class="token punctuation">;</span> <span class="token comment"># 启用压缩</span>
        gzip_min_length 1k<span class="token punctuation">;</span>    <span class="token comment"># 只压缩超过1K的文件</span>
        gzip_http_version <span class="token number">1.1</span><span class="token punctuation">;</span> <span class="token comment"># 启用gzip压缩所需的HTTP最低版本</span>
        gzip_comp_level <span class="token number">9</span><span class="token punctuation">;</span>     <span class="token comment"># 压缩级别，压缩比率越高，文件被压缩的体积越小</span>
        gzip_types  text/css application/javascript<span class="token punctuation">;</span><span class="token comment"># 进行压缩的文件类型</span>
        root /data/www/html<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    location ~ ^/download <span class="token punctuation">{</span>
        gzip_static on<span class="token punctuation">;</span> <span class="token comment"># 启用压缩</span>
        tcp_nopush on<span class="token punctuation">;</span>  <span class="token comment"># 不要着急发，攒一波再发</span>
        root /data/www<span class="token punctuation">;</span> <span class="token comment"># 注意此处目录是`/data/www`而不是`/data/www/download`</span>
    <span class="token punctuation">}</span> 
</code></pre></div><h3 id="浏览器缓存">浏览器缓存</h3> <p>校验本地缓存是否过期</p> <table><thead><tr><th>类型</th> <th>种类</th></tr></thead> <tbody><tr><td>检验是否过期</td> <td>Expires、Cache-Control(max-age)</td></tr> <tr><td>Etag</td> <td>Etag</td></tr> <tr><td>Last-Modified</td> <td>Last-Modified</td></tr></tbody></table> <p>expires<br>
添加Cache-Control、Expires头</p> <table><thead><tr><th>类型</th> <th>种类</th></tr></thead> <tbody><tr><td>语法</td> <td>expires time</td></tr> <tr><td>默认</td> <td>expires off;</td></tr></tbody></table> <p>上下文	http,server,location</p> <div class="language-shell extra-class"><pre class="language-shell"><code>location ~ .*<span class="token punctuation">\</span>.<span class="token punctuation">(</span>jpg<span class="token operator">|</span>png<span class="token operator">|</span>gif<span class="token punctuation">)</span>$ <span class="token punctuation">{</span>
        expires 24h<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="跨域">跨域</h3> <table><thead><tr><th>类型</th> <th>种类</th></tr></thead> <tbody><tr><td>语法</td> <td>add_header name value</td></tr> <tr><td>默认</td> <td>add_header --;</td></tr> <tr><td>上下文</td> <td>http,server,location</td></tr></tbody></table> <div class="language-shell extra-class"><pre class="language-shell"><code>location ~ .*<span class="token punctuation">\</span>.json$ <span class="token punctuation">{</span>
        add_header Access-Control-Allow-Origin http://localhost:3000<span class="token punctuation">;</span>
        add_header Access-Control-Allow-Methods GET,POST,PUT,DELETE,OPTIONS<span class="token punctuation">;</span>
        root /data/json<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre></div><div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">let</span> xhr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">XMLHttpRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
xhr<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">'GET'</span><span class="token punctuation">,</span> <span class="token string">'http://47.104.184.134/users.json'</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
xhr<span class="token punctuation">.</span><span class="token function-variable function">onreadystatechange</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>xhr<span class="token punctuation">.</span>readyState <span class="token operator">==</span> <span class="token number">4</span> <span class="token operator">&amp;&amp;</span> xhr<span class="token punctuation">.</span>status <span class="token operator">==</span> <span class="token number">200</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>xhr<span class="token punctuation">.</span>responseText<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
xhr<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="防盗链">防盗链</h3> <p>防止网站资源被盗用、保证信息安全、防止流量过量、区别哪些请求是非正常的用户请求
使用<code>http_refer</code>防盗链</p> <table><thead><tr><th>类型</th> <th>种类</th></tr></thead> <tbody><tr><td>语法</td> <td>valid_referers none	block	server_names	string...</td></tr> <tr><td>默认</td> <td>-</td></tr> <tr><td>上下文</td> <td>server,location</td></tr></tbody></table> <div class="language-shell extra-class"><div class="highlight-lines"><br><br><br><br><br><br><br><br><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><br><br></div><pre class="language-shell"><code>location ~ .*<span class="token punctuation">\</span>.<span class="token punctuation">(</span>jpg<span class="token operator">|</span>png<span class="token operator">|</span>gif<span class="token punctuation">)</span>$ <span class="token punctuation">{</span>
        expires 1h<span class="token punctuation">;</span>
        <span class="token function">gzip</span> off<span class="token punctuation">;</span>
        gzip_http_version <span class="token number">1.1</span><span class="token punctuation">;</span>
        gzip_comp_level <span class="token number">3</span><span class="token punctuation">;</span>
        gzip_types image/jpeg image/png image/gif<span class="token punctuation">;</span>
        <span class="token comment"># none没有refer blocked非正式HTTP请求 特定IP</span>
+       valid_referers none blocked <span class="token number">47.104</span>.184.134<span class="token punctuation">;</span>
+       <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$invalid_referer</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment"># 验证通过为0，不通过为1</span>
+           <span class="token builtin class-name">return</span> <span class="token number">403</span><span class="token punctuation">;</span>
+       <span class="token punctuation">}</span>
        root /data/images<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre></div><div class="language- extra-class"><pre class="language-text"><code>-e, --referer       Referer URL (H)
curl -e &quot;http://www.baidu.com&quot; http://192.171.207.104/girl.jpg
curl -e &quot;192.171.207.100&quot; http://192.171.207.104/girl.jpg
</code></pre></div><h3 id="代理服务">代理服务</h3> <p>正向代理即是客户端代理, 代理客户端, 服务端不知道实际发起请求的客户端.<br>
反向代理即是服务端代理, 代理服务端, 客户端不知道实际提供服务的服务端.</p> <p>配置</p> <table><thead><tr><th>类型</th> <th>种类</th></tr></thead> <tbody><tr><td>语法</td> <td>proxy_pass URL</td></tr> <tr><td>默认</td> <td>-</td></tr> <tr><td>上下文</td> <td>server,location</td></tr></tbody></table> <p>反向代理<br>
反向代理（Reverse Proxy）实际运行方式是指以代理服务器来接受internet上的连接请求，然后将请求转发给内部网络上的服务器，并将从服务器上得到的结果返回给internet上请求连接的客户端，此时代理服务器对外就表现为一个服务器。<br>
反向代理的作用：<br>
（1）保证内网的安全，阻止web攻击，大型网站，通常将反向代理作为公网访问地址，Web服务器是内网</p> <p>（2）负载均衡，通过反向代理服务器来优化网站的负载</p> <div class="language-shell extra-class"><pre class="language-shell"><code>resolver <span class="token number">8.8</span>.8.8<span class="token punctuation">;</span><span class="token comment"># 谷歌的域名解析地址</span>
location ~ ^/api <span class="token punctuation">{</span>
    <span class="token comment"># $http_host 要访问的主机名 $request_uri请求路径</span>
    proxy_pass http://127.0.0.1:3000<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>按<code>Win+R</code>系统热键打开运行窗口，输入<code>ipconfig /flushdns</code>命令后按回车，就可以清空电脑的DNS缓存</p> <p>正向代理</p> <p>正向代理类似一个跳板机，代理访问外部资源。<br>
正向代理的用途：<br>
（1）访问原来无法访问的资源，如google<br>
（2） 可以做缓存，加速访问资源<br>
（3）对客户端访问授权，上网进行认证<br>
（4）代理可以记录用户访问记录（上网行为管理），对外隐藏用户信息</p> <div class="language-shell extra-class"><pre class="language-shell"><code>location / <span class="token punctuation">{</span>
        proxy_pass http://<span class="token variable">$http_host</span><span class="token variable">$request_uri</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre></div><h3 id="负载均衡">负载均衡</h3> <p>使用集群是网站解决高并发、海量数据问题的常用手段。<br>
当一台服务器的处理能力、存储空间不足时，不要企图去换更强大的服务器，对大型网站而言，不管多么强大的服务器，都满足不了网站持续增长的业务需求。<br>
这种情况下，更恰当的做法是增加一台服务器分担原有服务器的访问及存储压力。通过负载均衡调度服务器，将来自浏览器的访问请求分发到应用服务器集群中的任何一台服务器上，如果有更多的用户，就在集群中加入更多的应用服务器，使应用服务器的负载压力不再成为整个网站的瓶颈。</p> <p>upstream<br>
nginx把请求转发到后台的一组upstream服务池<br>
Nginx可以配置代理多台服务器，当一台服务器宕机之后，仍能保持系统可用。</p> <table><thead><tr><th>类型</th> <th>种类</th></tr></thead> <tbody><tr><td>语法</td> <td>upstream name {}</td></tr> <tr><td>默认</td> <td>-</td></tr> <tr><td>上下文</td> <td>http</td></tr></tbody></table> <div class="language-shell extra-class"><pre class="language-shell"><code>upstream mamingjuan <span class="token punctuation">{</span>
  ip_hash<span class="token punctuation">;</span>
  server localhost:3000<span class="token punctuation">;</span>
  server localhost:4000<span class="token punctuation">;</span>
  server localhost:5000<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

server <span class="token punctuation">{</span>
    location / <span class="token punctuation">{</span>
        proxy_pass http://mamingjuan<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>后端服务器调试状态</p> <table><thead><tr><th>状态</th> <th>描述</th></tr></thead> <tbody><tr><td>down</td> <td>不参与负载均衡</td></tr> <tr><td>backup</td> <td>备份的服务器</td></tr> <tr><td>max_fails</td> <td>允许请求失败的次数</td></tr> <tr><td>fail_timeout</td> <td>经过max_fails失败后，服务暂停的时间</td></tr> <tr><td>max_conns</td> <td>限制最大的接收的连接数</td></tr></tbody></table> <div class="language-shell extra-class"><pre class="language-shell"><code>upstream mamingjuan <span class="token punctuation">{</span>
  server localhost:3000 down<span class="token punctuation">;</span>
  server localhost:4000 backup<span class="token punctuation">;</span>
  server localhost:5000 <span class="token assign-left variable">max_fails</span><span class="token operator">=</span><span class="token number">1</span> <span class="token assign-left variable">fail_timeout</span><span class="token operator">=</span>10s<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>分配方式</p> <table><thead><tr><th>类型</th> <th>种类</th></tr></thead> <tbody><tr><td>轮询（默认）</td> <td>每个请求按时间顺序逐一分配到不同的后端服务器，如果后端服务器down掉，能自动剔除。</td></tr> <tr><td>weight(加权轮询)</td> <td>指定轮询几率，weight和访问比率成正比，用于后端服务器性能不均的情况。</td></tr> <tr><td>ip_hash</td> <td>每个请求按访问ip的hash结果分配，这样每个访客固定访问一个后端服务器，可以解决session的问题。</td></tr> <tr><td>url_hash（第三方）</td> <td>按访问的URL地址来分配 请求，每个URL都定向到同一个后端 服务器上(缓存)</td></tr> <tr><td>fair（第三方）</td> <td>按后端服务器的响应时间来分配请求，响应时间短的优先分配。</td></tr> <tr><td>least_conn</td> <td>最小连接数，哪个连接少就分给谁</td></tr> <tr><td>自定义hash</td> <td>hash自定义key</td></tr></tbody></table> <div class="language- extra-class"><pre class="language-text"><code>upstream mamingjuan{
  ip_hash;
  server 127.0.0.1:3000;
}


upstream mamingjuan{
  least_conn;
  server 127.0.0.1:3000;
}


upstream mamingjuan{
  url_hash;
  server 127.0.0.1:3000;
}


upstream mamingjuan{
  fair;
  server 127.0.0.1:3000;
}


upstream mamingjuan{
  hash $request_uri;
  server 127.0.0.1:3000;
}
</code></pre></div><h3 id="缓存">缓存</h3> <p><a href="https://blog.csdn.net/dengjiexian123/article/details/53386586" target="_blank" rel="noopener noreferrer">nginx代理缓存<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <div class="language-shell extra-class"><pre class="language-shell"><code>http<span class="token punctuation">{</span>  
    <span class="token comment"># 缓存路径 目录层级 缓存空间名称和大小 失效时间为7天 最大容量为10g</span>
    proxy_cache_path /data/nginx/cache <span class="token assign-left variable">levels</span><span class="token operator">=</span><span class="token number">1</span>:2 <span class="token assign-left variable">keys_zone</span><span class="token operator">=</span>cache:100m <span class="token assign-left variable">inactive</span><span class="token operator">=</span>60m <span class="token assign-left variable">max_size</span><span class="token operator">=</span>10g<span class="token punctuation">;</span> 
<span class="token punctuation">}</span> 
</code></pre></div><ul><li>proxy_cache_path 缓存文件路径</li> <li>levels 设置缓存文件目录层次；levels=1:2 表示两级目录</li> <li>keys_zone 设置缓存名字和共享内存大小</li> <li>inactive 在指定时间内没人访问则被删除</li> <li>max_size 最大缓存空间，如果缓存空间满，默认覆盖掉缓存时间最长的资源。</li></ul> <div class="language-shell extra-class"><pre class="language-shell"><code>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$request_uri</span> ~ ^/cache/<span class="token punctuation">(</span>login<span class="token operator">|</span><span class="token builtin class-name">logout</span><span class="token punctuation">))</span> <span class="token punctuation">{</span>
      <span class="token builtin class-name">set</span> <span class="token variable">$nocache</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    location / <span class="token punctuation">{</span>
       proxy_pass http://mamingjuan<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    location ~ ^/cache/ <span class="token punctuation">{</span>
        proxy_cache cache<span class="token punctuation">;</span>
        proxy_cache_valid  <span class="token number">200</span> <span class="token number">206</span> <span class="token number">304</span> <span class="token number">301</span> <span class="token number">302</span> 60m<span class="token punctuation">;</span>   <span class="token comment"># 对哪些状态码缓存，过期时间为60分钟</span>
        proxy_cache_key <span class="token variable">$uri</span><span class="token punctuation">;</span>  <span class="token comment"># 缓存的维度</span>
        proxy_no_cache <span class="token variable">$nocache</span><span class="token punctuation">;</span>
        proxy_set_header Host <span class="token variable">$host</span><span class="token builtin class-name">:</span><span class="token variable">$server_port</span><span class="token punctuation">;</span>  <span class="token comment"># 设置头</span>
        proxy_set_header X-Real-IP <span class="token variable">$remote_addr</span><span class="token punctuation">;</span>   <span class="token comment"># 设置头</span>
        proxy_set_header   X-Forwarded-For <span class="token variable">$proxy_add_x_forwarded_for</span><span class="token punctuation">;</span>   <span class="token comment"># 设置头</span>
        proxy_pass http://127.0.0.1:6000<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre></div><ul><li>proxy_cache tmp-test 使用名为tmp-test的对应缓存配置</li> <li>proxy_cache_valid 200 206 304 301 302 10d; 对httpcode为200…的缓存10天</li> <li>proxy_cache_key $uri 定义缓存唯一key,通过唯一key来进行hash存取</li> <li>proxy_set_header 自定义http header头，用于发送给后端真实服务器。</li> <li>proxy_pass 指代理后转发的路径，注意是否需要最后的/</li></ul> <h3 id="rewrite">rewrite</h3> <p>可以实现url重写及重定向。用途包括URL页面跳转、兼容旧版本、SEO优化(伪静态)、维护(后台维护、流量转发)、安全(伪静态)</p> <div class="language- extra-class"><pre class="language-text"><code>语法	rewrite regex replacement [flag]
默认	-
上下文	server,location,if
</code></pre></div><p>解释：
regex 正则表达式指的是要被改写的路径<br>
replacement 目标要替换成哪个URL<br>
flag 标识</p> <p>实战</p> <div class="language- extra-class"><pre class="language-text"><code>rewrite ^(.*)$ /www/reparing.html break;
</code></pre></div><p>正则表达式就不在细讲了与javascript正则内容差不多。</p> <div class="language-shell extra-class"><pre class="language-shell"><code>if<span class="token punctuation">(</span><span class="token variable">$http_user_agent</span> ~ MSIE<span class="token punctuation">)</span><span class="token punctuation">{</span>
  rewrite ^<span class="token punctuation">(</span>.*<span class="token punctuation">)</span>$ /msie/<span class="token variable">$1</span> <span class="token builtin class-name">break</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>pcretest</p> <div class="language- extra-class"><pre class="language-text"><code>wget https://ftp.pcre.org/pub/pcre/pcre-8.13.tar.gz
tar -xzvf  pcre-8.13.tar.gz
cd pcre-8.13
./configure --enable-utf8  
make
make install
pcretest
</code></pre></div><p>flag<br>
标志位是标识规则对应的类型</p> <table><thead><tr><th>flag</th> <th>含义</th></tr></thead> <tbody><tr><td>last</td> <td>先匹配自己的location,然后通过rewrite规则新建一个请求再次请求服务端</td></tr> <tr><td>break</td> <td>先匹配自己的location,然后生命周期会在当前的location结束,不再进行后续的匹配</td></tr> <tr><td>redirect</td> <td>返回302昨时重定向,以后还会请求这个服务器</td></tr> <tr><td>permanent</td> <td>返回301永久重定向,以后会直接请求永久重定向后的域名</td></tr></tbody></table> <div class="language-shell extra-class"><pre class="language-shell"><code>location ~ ^/break <span class="token punctuation">{</span>
     rewrite ^/break /test <span class="token builtin class-name">break</span><span class="token punctuation">;</span>
     proxy_pass http://127.0.0.1:3000<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

location ~ ^/last <span class="token punctuation">{</span>
      rewrite ^/last /test last<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

location /test <span class="token punctuation">{</span>
      default_type application/json<span class="token punctuation">;</span>
      <span class="token builtin class-name">return</span> <span class="token number">200</span> <span class="token string">'{&quot;code&quot;:0,&quot;msg&quot;:&quot;success&quot;}'</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">curl</span> -vL http://192.168.20.150/redirect

location ~ ^/redirect <span class="token punctuation">{</span>
 rewrite ^/redirect http://www.baidu.com redirect<span class="token punctuation">;</span>
 rewrite ^/redirect http://www.baidu.com permanent<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>rewrite优先级</p> <ul><li>先执行server中的rewrite指令</li> <li>执行location匹配</li> <li>再执行location中的rewrite</li></ul> <p>location中的优先级</p> <ul><li>等号类型（=）的优先级最高。一旦匹配成功，则不再查找其他匹配项。</li> <li>^~类型表达式。一旦匹配成功，则不再查找其他匹配项。</li> <li>正则表达式类型（~ ~*）的优先级次之。如果有多个location的正则能匹配的话，则使用正则表达式最长的那个。</li> <li>常规字符串匹配类型按前缀匹配</li></ul></div></article> <section class="post-meta main-div" data-v-12a4d4fc><section class="post-date clearfix" data-v-12a4d4fc><span class="create-date" data-v-12a4d4fc>
      发布于 : 2017-12-07
    </span> <span class="update-date" data-v-12a4d4fc>
      修改于 : 2021-12-09
    </span></section> <section class="post-links" data-v-12a4d4fc><a href="/posts/2017/12/07/linux-environment.html" class="post-link" data-v-12a4d4fc>
      下一篇 : Linux methods to view and modify PATH environment variables
    </a> <a href="/posts/2017/12/06/different-extend.html" class="post-link" data-v-12a4d4fc>
      上一篇 : The difference between jquery.fn.extend and jquery.extend
    </a></section></section> <div id="post-comments" class="main-div"><!----></div></div></main> <aside class="aside" data-v-0874e876><div class="info-card main-div" data-v-2bd66a30 data-v-0874e876><div class="info-card-header" data-v-2bd66a30><img src="https://www.mamingjuan.cn/assets/img/avatar.jpeg" alt="Glitr" class="info-avatar" data-v-2bd66a30></div> <div class="info-card-body" data-v-2bd66a30><section class="info-nickname" data-v-2bd66a30>
      Glitr
    </section> <section class="info-desc" data-v-2bd66a30>Enjoy coding,<br/>Enjoy life:)</section> <section class="info-contact" data-v-2bd66a30><section data-v-2bd66a30><span title="Beijing City, China" data-v-2bd66a30 data-v-2bd66a30><svg class="icon" style="font-size:1em;" data-v-2bd66a30 data-v-2bd66a30><title data-v-2bd66a30 data-v-2bd66a30>Beijing City, China</title><use xlink:href="#icon-location" data-v-2bd66a30 data-v-2bd66a30></use></svg><span class="info-text" data-v-2bd66a30 data-v-2bd66a30>
          Beijing City, China
        </span></span></section> <section data-v-2bd66a30><span title="Secrecy" data-v-2bd66a30 data-v-2bd66a30><svg class="icon" style="font-size:1em;" data-v-2bd66a30 data-v-2bd66a30><title data-v-2bd66a30 data-v-2bd66a30>Secrecy</title><use xlink:href="#icon-organization" data-v-2bd66a30 data-v-2bd66a30></use></svg><span class="info-text" data-v-2bd66a30 data-v-2bd66a30>
          Secrecy
        </span></span></section> <section data-v-2bd66a30><a href="mailto:glitteringma@gmail.com" title="glitteringma@gmail.com" data-v-2bd66a30 data-v-2bd66a30><svg class="icon" style="font-size:1em;" data-v-2bd66a30 data-v-2bd66a30><title data-v-2bd66a30 data-v-2bd66a30>glitteringma@gmail.com</title><use xlink:href="#icon-email" data-v-2bd66a30 data-v-2bd66a30></use></svg><span class="info-text" data-v-2bd66a30 data-v-2bd66a30>
          glitteringma@gmail.com
        </span></a></section></section></div> <div class="info-card-footer" data-v-2bd66a30><section class="info-sns clearfix" data-v-2bd66a30><a href="https://github.com/happy760690" target="_blank" class="sns-link" data-v-2bd66a30><span title="GitHub: glitzma" class="sns-icon" data-v-2bd66a30 data-v-2bd66a30><svg class="icon" style="font-size:1.5em;" data-v-2bd66a30 data-v-2bd66a30><title data-v-2bd66a30 data-v-2bd66a30>GitHub: glitzma</title><use xlink:href="#icon-github" data-v-2bd66a30 data-v-2bd66a30></use></svg></span></a><a href="https://twitter.com/x0BKGuGTNoqZ0F7" target="_blank" class="sns-link" data-v-2bd66a30><span title="Twitter: x0BKGuGTNoqZ0F7" class="sns-icon" data-v-2bd66a30 data-v-2bd66a30><svg class="icon" style="font-size:1.5em;" data-v-2bd66a30 data-v-2bd66a30><title data-v-2bd66a30 data-v-2bd66a30>Twitter: x0BKGuGTNoqZ0F7</title><use xlink:href="#icon-twitter" data-v-2bd66a30 data-v-2bd66a30></use></svg></span></a><a href="https://www.instagram.com/glitz9558/?hl=en" target="_blank" class="sns-link" data-v-2bd66a30><span title="Instagram: glitz9558" class="sns-icon" data-v-2bd66a30 data-v-2bd66a30><svg class="icon" style="font-size:1.5em;" data-v-2bd66a30 data-v-2bd66a30><title data-v-2bd66a30 data-v-2bd66a30>Instagram: glitz9558</title><use xlink:href="#icon-instagram" data-v-2bd66a30 data-v-2bd66a30></use></svg></span></a></section></div></div> <div class="post-nav-card main-div" style="position:relative;top:0;width:0px;" data-v-0874e876><div class="post-nav-contents"><svg class="icon"><title>book</title><use xlink:href="#icon-book"></use></svg> <span>文章目录</span> <div class="post-nav-toc"><ul><li><a href="/posts/2017/12/07/nginx-proxy.html#nginx相关知识">nginx相关知识</a><ul><li><a href="/posts/2017/12/07/nginx-proxy.html#系统">系统</a></li><li><a href="/posts/2017/12/07/nginx-proxy.html#配置文件及用途">配置文件及用途</a></li><li><a href="/posts/2017/12/07/nginx-proxy.html#nginx内容配置">nginx内容配置</a></li><li><a href="/posts/2017/12/07/nginx-proxy.html#核心模块">核心模块</a></li><li><a href="/posts/2017/12/07/nginx-proxy.html#静态资源web服务">静态资源Web服务</a></li><li><a href="/posts/2017/12/07/nginx-proxy.html#浏览器缓存">浏览器缓存</a></li><li><a href="/posts/2017/12/07/nginx-proxy.html#跨域">跨域</a></li><li><a href="/posts/2017/12/07/nginx-proxy.html#防盗链">防盗链</a></li><li><a href="/posts/2017/12/07/nginx-proxy.html#代理服务">代理服务</a></li><li><a href="/posts/2017/12/07/nginx-proxy.html#负载均衡">负载均衡</a></li><li><a href="/posts/2017/12/07/nginx-proxy.html#缓存">缓存</a></li><li><a href="/posts/2017/12/07/nginx-proxy.html#rewrite">rewrite</a></li></ul></li></ul></div></div> <div class="post-nav-comments"><svg class="icon"><title>comment</title><use xlink:href="#icon-comment"></use></svg> <a href="/posts/2017/12/07/nginx-proxy.html#post-comments">
      评论
    </a></div></div></aside></div> <footer class="footer" data-v-e3c69672><p class="sns-links" data-v-e3c69672><a href="https://github.com/happy760690" target="_blank" class="sns-link" data-v-e3c69672><span title="GitHub: glitzma" class="sns-icon" data-v-e3c69672 data-v-e3c69672><svg class="icon" style="font-size:25px;" data-v-e3c69672 data-v-e3c69672><title data-v-e3c69672 data-v-e3c69672>GitHub: glitzma</title><use xlink:href="#icon-github" data-v-e3c69672 data-v-e3c69672></use></svg></span></a><a href="https://twitter.com/x0BKGuGTNoqZ0F7" target="_blank" class="sns-link" data-v-e3c69672><span title="Twitter: x0BKGuGTNoqZ0F7" class="sns-icon" data-v-e3c69672 data-v-e3c69672><svg class="icon" style="font-size:25px;" data-v-e3c69672 data-v-e3c69672><title data-v-e3c69672 data-v-e3c69672>Twitter: x0BKGuGTNoqZ0F7</title><use xlink:href="#icon-twitter" data-v-e3c69672 data-v-e3c69672></use></svg></span></a><a href="https://www.instagram.com/glitz9558/?hl=en" target="_blank" class="sns-link" data-v-e3c69672><span title="Instagram: glitz9558" class="sns-icon" data-v-e3c69672 data-v-e3c69672><svg class="icon" style="font-size:25px;" data-v-e3c69672 data-v-e3c69672><title data-v-e3c69672 data-v-e3c69672>Instagram: glitz9558</title><use xlink:href="#icon-instagram" data-v-e3c69672 data-v-e3c69672></use></svg></span></a></p> <div class="copyright" data-v-e3c69672>
    © 2014 –
    <span itemprop="copyrightYear" data-v-e3c69672>2021</span> <span class="post-meta-divider" data-v-e3c69672>|</span> <span itemprop="copyrightHolder" class="author" data-v-e3c69672>Glitr</span></div></footer></div><div class="global-ui"><!----><!----></div></div>
    <script src="/assets/js/app~d0ae3f07.60a8e50c.js" defer></script><script src="/assets/js/9.1267247d.js" defer></script><script src="/assets/js/53.76fe2763.js" defer></script><script src="/assets/js/app~db300d2f.1dc2ca0e.js" defer></script>
  </body>
</html>
